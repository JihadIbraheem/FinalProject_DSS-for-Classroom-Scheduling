
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Schedule</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .zoom-preview {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    max-width: 80%;
    max-height: 80%;
    border: 2px solid #ccc;
    background: #fff;
    display: none;
  }
  .zoom-preview img {
    width: 100%;
    height: auto;
  }
     .popup-img {
    cursor: zoom-in;
    transition: transform 0.2s;
  }

  .popup-overlay {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
  }

.calendar-table {
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  background-color: #f1f5f9;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(0,0,0,0.08);
}
.calendar-table th {
  background-color: #24459e;
  color: white;
  padding: 12px;
  font-weight: 600;
}
.calendar-table td {
  padding: 10px;
  vertical-align: top;
  border-bottom: 1px solid #e5e7eb;
}


  .popup-overlay img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }

  .popup-overlay.active {
    display: flex;
  }

    /* RESET & BASE */
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
    body { display:flex; flex-direction:column; min-height:100vh; background:#bfd2f8; color:#374151; }
    a { color:inherit; text-decoration:none; }
    button { cursor:pointer; }

    /* HEADER */
    header {
      background:#1E3A8A; color:#fff; padding:1rem 2rem;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .home-link { font-size:1.25rem; font-weight:600; }

    /* MAIN & FILTERS */
    main { flex:1; padding:2rem;background-color: #bfd2f8; }
        h2 {  color: #1E3A8A;
  margin-bottom: 1.5rem;
  text-align: center;
  font-size: 2rem; 
  font-weight: 600; 
  text-transform: uppercase;
letter-spacing: 1px;

}

    .filter-bar {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px;
    }
    .filter-bar input,
    .filter-bar select {
      padding:6px 10px; border-radius:4px; border:1px solid #ccc;
    }

    /* CARD GRID */
    .schedule-card-wrapper {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }
    .schedule-card {
      background:#fff; padding:16px; border-radius:8px;
      box-shadow:2px 2px 8px rgba(0,0,0,0.1);
      position:relative;
      display:flex; flex-direction:column;
    }
    .schedule-card h3 {
      margin-bottom:8px; font-size:1.1rem; color:#1E3A8A;
    }
    .schedule-card p { margin:4px 0; font-size:0.95rem; }
    .schedule-card button {
      margin-top:auto; padding:8px 12px; border:none;
      background:#2563EB; color:#fff; border-radius:4px;
      transition:background .2s;
    }
    .schedule-card button:hover { 
  background: linear-gradient(135deg, #4f46e5, #3b82f6) !important;}

    .schedule-box {
  position: relative;
  border-radius: 6px;
  padding: 10px 6px;
  margin: 4px 0;
  font-size: 13px;
  cursor: pointer;
  color: white;
  font-weight: 500;
  text-align: center;
  box-shadow: 0 5px 2px rgba(0,0,0,0.15);
  border: 1px solid #fff;
  white-space: normal;
  overflow: hidden;
  line-height: 1.4;
  min-height: 70px;
  height: auto;
  background-color: inherit;
  transition: transform 0.4s ease;
  transform-origin: left center;
  display: inline-block;
}
.schedule-content {
  transform: none !important;
}

.schedule-box:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}

  :root {
    --cs-color: #10B981; /* Computer Science - default green */
    --is-color: #2563EB; /* Information Systems - default blue */
    --other-color: #F59E0B; /* Other - default yellow */
  }

  .color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
  }

  .cs-label .color-box {
    background-color: var(--cs-color);
  }

  .is-label .color-box {
    background-color: var(--is-color);
  }

  .other-label .color-box {
    background-color: var(--other-color);
  }

.schedule-box.expanding {
  width: 200%;
  z-index: 10;
  position: relative;
  transition: width 0.4s ease;
    transform: none !important;
  width: 100%;
  white-space: normal;
  word-wrap: break-word;
}


    /* MODALS */
    .modal-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 100;
  align-items: center;
  justify-content: center;
  
  overflow: auto;
  padding: 20px;
   }
.calendar-grid {
  overflow-x: auto;
  width: 100%;
}


    .modal {
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  max-width:450px;
  width:95%;
  max-height: 80vh;
  overflow-y: auto;
  position:relative;
  animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to   { opacity: 1; transform: scale(1); }
}
#classroomModalBackdrop .modal {
  max-height: 95vh; 
  min-height: 400px; 
  overflow-y: auto;
  scrollbar-width: thick;
}
.modal input,
.modal select {
  margin-bottom: 8px;
}

    .modal h3 { margin-bottom:12px; color:#1E3A8A; }
    .modal label { display:block; margin:8px 0 4px; font-weight:500; }
    .modal input, .modal select {
      width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;
    }
    .modal button.check-available {
  background: linear-gradient(135deg, #3B82F6, #1D4ED8);
  color: #fff;
  font-weight: bold;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: background 0.3s ease, transform 0.2s;
}
.modal button.check-available:hover {
  background: linear-gradient(135deg, #2563EB, #1E40AF);
  transform: scale(1.04);
}

    .modal button.cancel { background:#6B7280; }
    .modal ul {  list-style: none;
  padding: 0;
  max-height: 60vh;
  overflow-y: auto;}
    .modal ul li {
      padding:8px; border:1px solid #ddd; border-radius:4px; margin:6px 0;
      cursor:pointer; transition:background .2s;
    }
    .modal ul li:hover { background:#F3F4F6; }

    /* FOOTER */
    footer {
      background:#1E3A8A; color:#fff; text-align:center;
      padding:1rem; font-size:0.9rem;
    }
  </style>
</head>
<body>
<header style="background:#1E3A8A; color:#fff; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
  <a href="/home" class="home-link" style="font-size:1.25rem; font-weight:600; color:inherit; text-decoration:none;">Classroom Scheduling System</a>
  <a href="/logout" class="logout-button" style="background:#ffffff; color:#1E3A8A; padding:6px 12px; border-radius:4px; font-weight:bold; transition:all 0.3s ease; text-decoration:none;"
     onmouseover="this.style.backgroundColor='#e5e7eb'; this.style.color='#111827'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)'"
     onmouseout="this.style.backgroundColor='#ffffff'; this.style.color='#1E3A8A'; this.style.boxShadow='none'">
    Log Out
  </a>
</header>


  <main>
    <h2 style="text-align:center">Weekly Visual Schedule</h2>
<!-- ניווט בין ימים -->
<div style="text-align: center; margin-bottom: 20px;">
  <button onclick="previousDay()" style="
    background: linear-gradient(135deg, #6366F1, #3B82F6);
    color: white;
    border: none;
    padding: 10px 16px;
    margin: 0 8px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s;
  " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">&lt;</button>

  <span id="current-day-label" style="font-size: 18px; font-weight: bold;">א'</span>

  <button onclick="nextDay()" style="
    background: linear-gradient(135deg, #6366F1, #3B82F6);
    color: white;
    border: none;
    padding: 10px 16px;
    margin: 0 8px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s;
  " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">&gt;</button>
</div>

<!-- מקרא צבעים למחלקות -->

<div style="text-align:center; margin-top: 10px; margin-bottom: 20px;">
  <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-top: 8px;">
  <div class="color-picker-group">
  <label>Computer Science:</label>
  <input type="color" id="color-computer-science" value="#10B981" onchange="updateScheduleColors()">
</div>
<div class="color-picker-group">
  <label>Information Systems:</label>
  <input type="color" id="color-information-systems" value="#2563EB" onchange="updateScheduleColors()">
</div>
<div class="color-picker-group">
  <label>Other:</label>
  <input type="color" id="color-other" value="#F59E0B" onchange="updateScheduleColors()">
</div>

</div>

</div>



    <div style="overflow-x:auto">
        <div id="calendar-grid" class="calendar-grid"></div>
        <tbody id="schedule-body">
          
        </tbody>
      </table>
    </div>
  </main>

<!-- Include existing edit modal -->
<div id="editModalBackdrop" class="modal-backdrop" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <!-- כפתור סגירה -->
    <span onclick="closeModal()" style="
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 29px;
      color: #f50b0b;
      cursor: pointer;
      font-weight: bold;
    " title="Close">×</span>

    <!-- שדות חבויים -->
    <input type="hidden" id="modal-schedule-id" />
    <input type="hidden" id="modal-classroom" />

    <!-- מידע נוכחי -->
    <label>Current Classroom</label>
    <input type="text" id="modal-current-classroom" readonly />

    <label>Building Name</label>
    <input type="text" id="modal-building-name" readonly />

    <label>Course Name</label>
    <input type="text" id="modal-course-name" readonly />

    <label>Lecturer Name</label>
    <input type="text" id="modal-lecturer" readonly />

    <hr style="border: none; border-top: 2px solid #1E3A8A; margin: 16px 0;">
    <div style="background:#F9FAFB; padding:12px; border-radius:6px; margin-top:12px;">
      <p style="margin: 10px 0; font-weight: 600; color: #1E3A8A;">Edit Schedule</p>

      <label>Weekday</label>
      <select id="modal-weekday">
        <option value="א'">א'</option>
        <option value="ב'">ב'</option>
        <option value="ג'">ג'</option>
        <option value="ד'">ד'</option>
        <option value="ה'">ה'</option>
        <option value="ו'">ו'</option>
      </select>

      <label>Start Time</label>
      <input type="time" id="modal-start" />

      <label>End Time</label>
      <input type="time" id="modal-end" />

      <label>Capacity</label>
      <input type="number" id="modal-capacity" />

      <label>Remote Learning</label>
      <select id="modal-remote">
        <option value="">Doesn't matter</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>

      <label>Sheltered</label>
      <select id="modal-sheltered">
        <option value="">Doesn't matter</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>

      <label>Number of Boards</label>
      <input type="number" id="modal-board-count" min="0" />

      <button class="check-available" onclick="submitEditModal()">Check available classrooms</button>
    </div>
  </div>
</div>

 <!-- CLASSROOM SELECTION MODAL -->
<!-- CLASSROOM SELECTION MODAL -->
<div id="classroomModalBackdrop" class="modal-backdrop" onclick="closeClassroomModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <!-- הוספת כפתור סגירה -->
    <span onclick="closeClassroomModal()" style="
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 29px;
      color: #f50b0b;
      cursor: pointer;
      font-weight: bold;
    " title="Close">×</span>

    <h3>Select New Classroom</h3>
    <ul id="classroom-options-list"></ul>
  </div>
</div>

<div id="zoomContainer" class="zoom-preview">
  <img id="zoomImage" src="" alt="Zoomed">
</div>

<!-- NO-CLASSROOMS MODAL -->
<div id="noClassroomModalBackdrop" class="modal-backdrop" onclick="closeNoClassroomModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <span onclick="closeNoClassroomModal()" style="
      position:absolute; top:10px; right:12px;
      font-size:29px; color:#f50b0b; font-weight:bold; cursor:pointer;">×</span>

    <h3 style="margin-bottom:12px;">No available classrooms found</h3>
    <p style="margin-bottom:18px;">
      Would you like to search again without the <b>Remote Learning</b> &
      <b>Sheltered</b> constraints?
    </p>

    <button class="check-available" onclick="searchIgnoringRemoteSheltered()" style="
      background:linear-gradient(135deg,#3B82F6,#1D4ED8);
      color:#fff; font-weight:600; padding:10px 16px;
      border:none; border-radius:6px; cursor:pointer;">
      Search with relaxed constraints
    </button>
    <button class="check-available" onclick="searchAlternativeTimes()"
        style="margin-top: 10px; background: linear-gradient(135deg,#10B981,#059669);">
        Search on different time/day
    </button>

  </div>
</div>

  <script>
    let currentDayIndex = 0;
const weekdays = ["א'", "ב'", "ג'", "ד'", "ה'", "ו'"];

function updateDayLabel() {
  document.getElementById('current-day-label').textContent = weekdays[currentDayIndex];
}

function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    schedule_id: params.get('schedule_id'),
    weekday: params.get('weekday')
  };
}

function previousDay() {
  currentDayIndex = (currentDayIndex - 1 + weekdays.length) % weekdays.length;
  updateDayLabel();
  renderBuildingSchedule();
}

function nextDay() {
  currentDayIndex = (currentDayIndex + 1) % weekdays.length;
  updateDayLabel();
  renderBuildingSchedule();
}

    function closeModal() {
  document.getElementById('editModalBackdrop').style.display = 'none';
}

async function renderBuildingSchedule() {
  const res = await fetch('/api/schedules');
  const { schedules } = await res.json();
  const container = document.getElementById('calendar-grid');
  container.innerHTML = '';

  const selectedDay = weekdays[currentDayIndex];
  const filtered = schedules.filter(s => s.weekday === selectedDay);
  const buildings = [...new Set(filtered.map(s => s.building_name))].sort();
  const hours = Array.from({ length: 12 }, (_, i) => `${8 + i}:00`);

function getDynamicFacultyColor(course_id) {
  const dept_code = course_id.split('.')[0];

  const csColor = document.getElementById('color-computer-science')?.value || '#10B981';
  const isColor = document.getElementById('color-information-systems')?.value || '#2563EB';
  const otherColor = document.getElementById('color-other')?.value || '#F59E0B';

  if (dept_code === '203') return csColor;
  if (dept_code === '214') return isColor;
  return otherColor;
}

  const table = document.createElement('table');
  table.className = 'calendar-table';

  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.appendChild(document.createElement('th'));
  hours.forEach(hour => {
    const th = document.createElement('th');
    th.textContent = hour;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  buildings.forEach(building => {
    const row = document.createElement('tr');
    const nameCell = document.createElement('td');
    nameCell.textContent = building;
    row.appendChild(nameCell);

    hours.forEach(hour => {
      const cell = document.createElement('td');
      cell.style.position = 'relative';

      const matches = filtered.filter(s => {
        const startHour = parseInt(s.time_start.split(':')[0]);
        return s.building_name === building && startHour === parseInt(hour);
      });

      matches.forEach(s => {
        const start = s.time_start.split(':').map(Number);
        const end = s.time_end.split(':').map(Number);
        const startMin = start[0] * 60 + start[1];
        const endMin = end[0] * 60 + end[1];
        const durationMin = endMin - startMin;

        const block = document.createElement('div');
        block.className = 'schedule-box';
        block.style.backgroundColor = getDynamicFacultyColor(s.course_id);
        
        block.style.position = 'relative';
        block.style.height = 'auto';

        block.innerHTML = `
        <div class="schedule-content">
              <strong>${s.course_name}</strong><br>
              ${s.classroom_num}<br>
              ${s.time_start} - ${s.time_end}<br>
              ${s.lecturer_name}
              </div>
              `;

        block.title = `Course: ${s.course_name}
Classroom: ${s.classroom_num}
Lecturer: ${s.lecturer_name}
${s.time_start} - ${s.time_end}`;

let expandTimeout;
block.addEventListener('mouseenter', () => {
  expandTimeout = setTimeout(() => {
    const scale = durationMin / 60;
    block.style.transform = `scaleX(${scale})`;
    block.style.zIndex = '10';
  }, 2000);
});

block.addEventListener('mouseleave', () => {
  clearTimeout(expandTimeout);
  block.style.transform = '';
  block.style.zIndex = '';
});

        block.onclick = () => editRow(s.schedule_id);
        cell.appendChild(block);
      });

      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}

function formatTimeToInput(value) {
  if (!value || !value.includes(':')) return '';
  const [h, m] = value.split(':');
  return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
}

async function renderCalendarView() {
  const res = await fetch('/api/schedules');
  const { schedules } = await res.json();
  const container = document.getElementById('calendar-grid');
  container.innerHTML = '';

  const weekdays = ["א'", "ב'", "ג'", "ד'", "ה'", "ו'"];
  const hours = Array.from({ length: 12 }, (_, i) => `${8 + i}:00`);

  const table = document.createElement('table');
  table.classList.add('calendar-table');
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');

  headerRow.appendChild(document.createElement('th'));

  weekdays.forEach(day => {
    const th = document.createElement('th');
    th.textContent = day;
    headerRow.appendChild(th);
  });

  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  hours.forEach(hour => {
    const row = document.createElement('tr');
    const hourCell = document.createElement('td');
    hourCell.textContent = hour;
    row.appendChild(hourCell);

    weekdays.forEach(day => {
      const cell = document.createElement('td');
      cell.style.position = 'relative';

      schedules.forEach(s => {
        if (s.weekday === day && s.time_start.startsWith(hour)) {
          const box = document.createElement('div');
          box.className = 'schedule-box';
          box.innerHTML = `
            <strong>${s.course_name}</strong><br>
            ${s.lecturer_name}<br>
            ${s.classroom_num}<br>
            ${s.time_start} - ${s.time_end}
          `;
          box.onclick = () => editRow(s.schedule_id);
          cell.appendChild(box);
        }
      });

      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}

    async function loadVisualSchedule() {
      const res = await fetch('/api/schedules');
      const { schedules } = await res.json();
      const tbody = document.getElementById('schedule-body');
      tbody.innerHTML = '';

      const rooms = [...new Set(schedules.map(s => s.classroom_num))];
      const hours = [8,9,10,11,12,13,14,15,16,17,18,19];

      rooms.forEach(room => {
        const row = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = room;
        row.appendChild(td);

        hours.forEach(h => {
          const hourCell = document.createElement('td');

          const matches = schedules.filter(s => 
            s.classroom_num === room && parseInt(s.time_start.split(':')[0]) === h
          );

          matches.forEach(s => {
            const block = document.createElement('div');
            block.className = 'schedule-block';
            block.innerHTML = `
              ${s.course_name}<br>
              ${s.weekday} ${s.time_start} - ${s.time_end}<br>
              ${s.lecturer_name}
            `;
            block.onclick = () => editRow(s.schedule_id);
            hourCell.appendChild(block);
          });

          row.appendChild(hourCell);
        });

        tbody.appendChild(row);
      });
    }
    
async function submitEditModal() {
  const schedule_id = document.getElementById('modal-schedule-id').value;
  if (!schedule_id) {
    alert("Schedule ID is missing");
    return;
  }

  const weekday            = document.getElementById('modal-weekday').value;
  const time_start         = document.getElementById('modal-start').value;
  const time_end           = document.getElementById('modal-end').value;
  const capacity           = parseInt(document.getElementById('modal-capacity').value);
  const is_remote_learning = document.getElementById('modal-remote').value;
  const is_sheltered       = document.getElementById('modal-sheltered').value;
  const board_count        = parseInt(document.getElementById('modal-board-count').value);
  const selected_classroom_num = document.getElementById('modal-selected-classroom')?.value || null;

  const original = window.originalSchedule || {};

  if (
    weekday === original.weekday &&
    time_start === original.time_start &&
    time_end === original.time_end &&
    capacity === Number(original.capacity) &&
    is_remote_learning === original.is_remote_learning &&
    is_sheltered === original.is_sheltered &&
    board_count === Number(original.board_count)
  ) {
    alert("Please change at least one field before checking available classrooms.");
    return;
  }

  const start = new Date(`1970-01-01T${time_start}:00`);
  const end   = new Date(`1970-01-01T${time_end}:00`);
  if (isNaN(start) || isNaN(end) || start >= end) {
    alert("Start time must be earlier than end time.");
    return;
  }
  if ((end - start) / 36e5 > 8) {
    alert("Maximum duration is 8 hours.");
    return;
  }
  if (start.getMinutes() !== 0 || end.getMinutes() !== 0) {
    alert("Times must be on the hour (e.g. 08:00).");
    return;
  }
  if (isNaN(board_count) || board_count < 0 || board_count > 3) {
    alert("Number of boards must be between 0 and 3.");
    return;
  }

  const payload = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    is_remote_learning,
    is_sheltered,
    board_count,
    selected_classroom_num
  };

  // ✅ שמירת נתוני העריכה לשימוש בהמשך (גם במודל הרגיל)
  window.pendingEditData = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    is_remote_learning,
    is_sheltered,
    board_count
  };

  const res = await fetch('/api/save_schedule_update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const result = await res.json();

  if (result.success) {
    alert("Update successful");
    closeModal();
    renderBuildingSchedule();
    return;
  }

  if (result.message === "No available classroom matches the new constraints") {
    const opts = result.available_classrooms || [];
    if (opts.length) {
      openClassroomSelectionModal(opts);
      return;
    }
  }

  if (result.message === "No available classrooms found") {
    document.getElementById('noClassroomModalBackdrop').style.display = 'flex';
    return;
  }

  alert("Update failed: " + (result.message || "Unknown error"));
}



function showZoom(src) {
    const zoom = document.getElementById("zoomContainer");
    const img = document.getElementById("zoomImage");
    img.src = src;
    zoom.style.display = "block";
  }

  function hideZoom() {
    document.getElementById("zoomContainer").style.display = "none";
  }

  function getDynamicFacultyColor(course_id) {
  const dept_code = course_id.split('.')[0];

  const csColor = document.getElementById('color-computer-science')?.value || '#10B981';
  const isColor = document.getElementById('color-information-systems')?.value || '#2563EB';
  const otherColor = document.getElementById('color-other')?.value || '#F59E0B';

  if (dept_code === '203') return csColor;
  if (dept_code === '214') return isColor;
  return otherColor;
}
function updateScheduleColors() {
  renderBuildingSchedule();  // תגרום לצביעה מחדש בזמן אמת
}

/* סגירת המודל הקטן */
function closeNoClassroomModal(){
  document.getElementById('noClassroomModalBackdrop').style.display = 'none';
}

/* חיפוש מחדש ללא Remote Learning & Sheltered */
async function searchIgnoringRemoteSheltered(){
  closeNoClassroomModal();

  if (!window.pendingEditData){ return; }
  const relaxedData                = { ...window.pendingEditData };
  relaxedData.is_remote_learning   = '';   // מרוקן → מתעלם מהאילוץ
  relaxedData.is_sheltered         = '';

  const res    = await fetch('/api/save_schedule_update',{
                     method:'POST',
                     headers:{'Content-Type':'application/json'},
                     body:JSON.stringify(relaxedData)
                 });
  const result = await res.json();

  if (result.available_classrooms && result.available_classrooms.length){
      openClassroomSelectionModal(result.available_classrooms, relaxedData);
  }else{
      alert("Still no classrooms available even after relaxing constraints.");
  }
}

async function searchAlternativeTimes() {
  const schedule_id       = document.getElementById('modal-schedule-id').value;
  const weekday           = document.getElementById('modal-weekday').value;
  const time_start        = document.getElementById('modal-start').value;
  const time_end          = document.getElementById('modal-end').value;
  const capacity          = parseInt(document.getElementById('modal-capacity').value);
  const board_count       = parseInt(document.getElementById('modal-board-count').value);

  const payload = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    board_count,
    is_remote_learning: "",  // התעלמות
    is_sheltered: "",        // התעלמות
    allow_flexible_time: true
  };

  const res = await fetch('/api/search_alternative_slots', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const result = await res.json();

  if (result.success && result.available_classrooms?.length > 0) {
    const enrichedPayload = {
      ...payload,
      fromAlternativeSearch: true,
      time_start: result.time_start,
      time_end: result.time_end,
      weekday: result.weekday
    };
    openClassroomSelectionModal(result.available_classrooms, enrichedPayload);
  } else {
    alert(result.message || "No available classrooms found on different times or days.");
  }
}


/* ----- RICH CLASSROOM SELECTION MODAL (with images) ----- */
function openClassroomSelectionModal(classroomOptions, dataPayload = null) {
  const previousModal = document.getElementById('noClassroomModalBackdrop');
  if (previousModal) previousModal.style.display = 'none';

  const modal = document.getElementById('classroomModalBackdrop');
  const list  = document.getElementById('classroom-options-list');
  list.innerHTML = '';

  const showTimeInfo = dataPayload?.fromAlternativeSearch;

  classroomOptions.forEach(c => {
    const li = document.createElement('li');

    const parts = c.classroom_num.split('-');
    const floor = parts.length === 3 ? parseInt(parts[1], 10) : '-';
    const roomNumber = parts.length === 3 ? parts[2] : c.classroom_num;

    const encodedBld = encodeURIComponent(c.building_name);
    const baseDir = `/uploads/img/${encodedBld}/${roomNumber}`;
    const MAX_CHECKS = 5;
    const imagePaths = [];

    let checksDone = 0;
    for (let i = 1; i <= MAX_CHECKS; i++) {
      const src = `${baseDir}/${i}.jpg`;
      const img = new Image();
      img.onload = () => { imagePaths.push(src); afterCheck(); };
      img.onerror = afterCheck;
      img.src = src;
    }

    function afterCheck() {
      checksDone++;
      if (checksDone === MAX_CHECKS) renderLi();
    }

    function renderLi() {
      li.innerHTML = '';

      const gallery = document.createElement('div');
      gallery.style.display = 'flex';
      gallery.style.flexWrap = 'wrap';
      gallery.style.gap = '8px';
      gallery.style.justifyContent = 'center';
      gallery.style.marginBottom = '8px';

      if (imagePaths.length === 0) {
        gallery.innerHTML = `<div style="color:#888;">No images available</div>`;
      } else {
        imagePaths.forEach((src, idx) => {
          const img = document.createElement('img');
          img.src = src;
          img.alt = `Classroom Image ${idx + 1}`;
          img.style.width = '30%';
          img.style.maxHeight = '120px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '6px';
          img.className = 'popup-img';
          img.onclick = e => { e.stopPropagation(); showGallery(imagePaths, idx); };
          gallery.appendChild(img);
        });
      }
      li.appendChild(gallery);

      let timeInfoHTML = '';
      if (showTimeInfo && dataPayload?.weekday && dataPayload?.time_start && dataPayload?.time_end) {
        timeInfoHTML = `
          <div style="background: linear-gradient(to right, #e0f7fa, #b2ebf2); color: #006064; padding: 6px; border-radius: 6px; margin-top: 8px;">
            <strong>Suggested:</strong> ${dataPayload.weekday}, ${dataPayload.time_start}–${dataPayload.time_end}
          </div>
        `;
      }

      li.insertAdjacentHTML('beforeend', `
        <strong>Classroom:</strong> ${roomNumber}<br>
        <strong>Building:</strong> ${c.building_name}<br>
        <strong>Floor:</strong> ${floor}<br>
        <strong>Capacity:</strong> ${c.capacity}<br>
        <strong>Remote Learning:</strong> ${c.is_remote_learning == 1 || c.is_remote_learning === '1' ? 'Yes' : 'No'}<br>
        <strong>Sheltered:</strong> ${c.is_sheltered == 1 || c.is_sheltered === '1' ? 'Yes' : 'No'}<br>
        <strong>Boards:</strong> ${c.board_count}
        ${timeInfoHTML}
      `);

      li.style.cursor = 'pointer';
      li.style.margin = '6px 0';
      li.style.padding = '6px';
      li.style.border = '1px solid #ddd';
      li.style.borderRadius = '6px';
      li.onmouseenter = () => li.style.backgroundColor = '#F3F4F6';
      li.onmouseleave = () => li.style.backgroundColor = 'white';

      li.onclick = async e => {
        if (e.target.tagName === 'IMG') return;

        const confirmMsg = `Are you sure you want to switch to classroom ${c.classroom_num}?`;
        if (!confirm(confirmMsg)) return;

        const payload = dataPayload ? { ...dataPayload } : (window.pendingEditData || {});
        payload.selected_classroom_num = c.classroom_num;
        modal.style.display = 'none';

        const res = await fetch('/api/save_schedule_update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
          alert('Update successful');
          closeModal();
          renderBuildingSchedule();
        } else {
          alert('Update failed: ' + (result.message || 'Unknown error'));
        }
      };

      list.appendChild(li);
    }
  });

  modal.style.display = 'flex';
}


async function editRow(schedule_id) {
  const res = await fetch(`/api/schedule_details/${schedule_id}`);
  const data = await res.json();

  // קריטי: קישור schedule_id לשדה חבוי במודל
  document.getElementById('modal-schedule-id').value = schedule_id;

  // עדכון שדות כיתה
  document.getElementById('modal-current-classroom').value = (data.classroom_num || '').split('-').pop();
  document.getElementById('modal-building-name').value = data.building_name || '';
  document.getElementById('modal-classroom').value = data.classroom_num || '';

  // הוספת תמונות של הכיתה (אם קיימות)
  const imgContainer = document.createElement('div');
  imgContainer.style.display = 'flex';
  imgContainer.style.flexWrap = 'wrap';
  imgContainer.style.gap = '8px';
  imgContainer.style.marginTop = '12px';

  (data.images || []).forEach(src => {
    const img = document.createElement('img');
    img.src = src;
    img.alt = 'Classroom Image';
    img.style.width = '30%';
    img.style.maxHeight = '120px';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '6px';
    imgContainer.appendChild(img);
  });

  // מנקה קודמים אם קיימים
  const modal = document.querySelector('#editModalBackdrop .modal');
  const oldImgs = modal.querySelectorAll('img');
  oldImgs.forEach(img => img.remove());
  modal.appendChild(imgContainer);

  // עדכון שדות נוספים
  document.getElementById('modal-course-name').value = data.course_name || '';
  document.getElementById('modal-lecturer').value = data.lecturer_name || '';
  document.getElementById('modal-weekday').value = data.weekday || '';
  document.getElementById('modal-start').value = formatTimeToInput(data.time_start);
  document.getElementById('modal-end').value = formatTimeToInput(data.time_end);
  document.getElementById('modal-capacity').value = data.capacity || '';
  document.getElementById('modal-remote').value = data.is_remote_learning || '';
  document.getElementById('modal-sheltered').value = data.is_sheltered || '';
  document.getElementById('modal-board-count').value = data.boards.length || 0;

  // הצגת המודל
  document.getElementById('editModalBackdrop').style.display = 'flex';

  // שמירה להשוואת שינויים בהמשך
  window.originalSchedule = {
    weekday: data.weekday || '',
    time_start: data.time_start || '',
    time_end: data.time_end || '',
    capacity: data.capacity || '',
    is_remote_learning: data.is_remote_learning || '',
    is_sheltered: data.is_sheltered || '',
    board_count: data.boards.length || 0
  };
}



function updateCategoryColor(category, color) {
  // Update the color box
  document.getElementById(`${category}-color-box`).style.backgroundColor = color;

  // Update all relevant schedule cards
  const cards = document.querySelectorAll(`[data-department='${category}']`);
  cards.forEach(card => {
    card.style.backgroundColor = color;
  });
}

    function closeClassroomModal() {
      document.getElementById('classroomModalBackdrop').style.display = 'none';
    }

    
    window.onload = async () => {
  const { schedule_id, weekday } = getUrlParams();

  if (weekday) {
    const index = weekdays.indexOf(weekday);
    if (index !== -1) currentDayIndex = index;
    updateDayLabel();
  }

  await renderBuildingSchedule();

  if (schedule_id) {
    editRow(schedule_id);
  }
};


    async function loadSchedules() {
  const res = await fetch('/api/schedules');
  const json = await res.json();
  renderCalendarView(json.schedules || json);
}

function showPopup(src) {
  const popup = document.getElementById('imagePopup');
  const popupImg = document.getElementById('popupImage');
  popupImg.src = src;
  popup.classList.add('active');
}

function hidePopup() {
  document.getElementById('imagePopup').classList.remove('active');
}

let currentImageIndex = 0;
let galleryImages = [];

function showGallery(images, startIndex = 0) {
  galleryImages = images;
  currentImageIndex = startIndex;
  const overlay = document.getElementById('imageGalleryOverlay');
  const imgTag = document.getElementById('galleryImage');
  imgTag.src = galleryImages[currentImageIndex];
  overlay.style.display = 'flex';
}

function nextImage() {
  currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
  document.getElementById('galleryImage').src = galleryImages[currentImageIndex];
}

function prevImage() {
  currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
  document.getElementById('galleryImage').src = galleryImages[currentImageIndex];
}

function closeGallery() {
  document.getElementById('imageGalleryOverlay').style.display = 'none';
}
  function updateLegendColor(boxId, color) {
    document.getElementById(boxId).style.backgroundColor = color;
  }
  </script>

<div id="imagePopup" class="popup-overlay" onclick="hidePopup()">
  <img id="popupImage" src="" alt="Enlarged Image" />
</div>

<!-- גלריית תמונות קופצת -->
<div id="imageGalleryOverlay" class="popup-overlay" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9990;
  justify-content: center;
  align-items: center;
" onclick="closeGallery()">

  <div id="galleryInner" style="
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    max-width: 90vw;
    max-height: 90vh;
    margin: auto;
  " onclick="event.stopPropagation()">

    <!-- כפתור סגירה -->
    <span onclick="closeGallery()" style="
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 28px;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      z-index: 10001;
    " title="Close">×</span>

    <!-- חץ אחורה -->
    <button onclick="event.stopPropagation(); prevImage()" style="
      position: absolute;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 28px;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;
    " title="Previous">❮</button>

    <!-- התמונה -->
    <img id="galleryImage" style="
      max-width: 80vw;
      max-height: 80vh;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
      z-index: 9998;
    " />

    <!-- חץ קדימה -->
    <button onclick="event.stopPropagation(); nextImage()" style="
      position: absolute;
      right: -60px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 28px;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;
    " title="Next">❯</button>

  </div>
</div>




  <footer>
    <p>&copy; 2025 Classroom Scheduling System</p>
  </footer>
</body>
</html>


