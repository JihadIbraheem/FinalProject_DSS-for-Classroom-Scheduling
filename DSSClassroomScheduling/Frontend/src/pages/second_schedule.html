<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Schedule</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    /* RESET & BASE */
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
    body { display:flex; flex-direction:column; min-height:100vh; background:#F3F4F6; color:#374151; }
    a { color:inherit; text-decoration:none; }
    button { cursor:pointer; }

    /* HEADER */
    header {
      background:#1E3A8A; color:#fff; padding:1rem 2rem;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .home-link { font-size:1.25rem; font-weight:600; }

    /* MAIN & FILTERS */
    main { flex:1; padding:2rem; }
    h2 { color:#1E3A8A; margin-bottom:1.5rem; text-align:center; }

    .filter-bar {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px;
    }
    .filter-bar input,
    .filter-bar select {
      padding:6px 10px; border-radius:4px; border:1px solid #ccc;
    }

    /* CARD GRID */
    .schedule-card-wrapper {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }
    .schedule-card {
      background:#fff; padding:16px; border-radius:8px;
      box-shadow:2px 2px 8px rgba(0,0,0,0.1);
      position:relative;
      display:flex; flex-direction:column;
    }
    .schedule-card h3 {
      margin-bottom:8px; font-size:1.1rem; color:#1E3A8A;
    }
    .schedule-card p { margin:4px 0; font-size:0.95rem; }
    .schedule-card button {
      margin-top:auto; padding:8px 12px; border:none;
      background:#2563EB; color:#fff; border-radius:4px;
      transition:background .2s;
    }
    .schedule-card button:hover { background:#1E40AF; }

.schedule-box {
  border-radius: 6px;
  padding: 6px;
  margin: 2px;
  font-size: 12px;
  cursor: pointer;
  color: white;
  font-weight: 500;
  text-align: center;
  box-shadow: 0 5px 2px rgba(0,0,0,0.15);
  border: 1px solid #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: width 0.4s ease;
  display: block;
  width: 100%;
}
 
.schedule-box.expanding {
  transform: scaleX(1.5);
  transform-origin: left;
  z-index: 10;
  position: relative;
  white-space: normal;        /* שורה חדשה אם צריך */
  overflow: hidden;           /* הגבלת גלישה */
  text-overflow: ellipsis;    /* שלוש נקודות אם נחתך */
}

.schedule-box * {
  transform: none !important;   /* ביטול הגדלה של הטקסט */
}

.schedule-box:hover {
  transform: scale(1.05);
}

.schedule-box.expanding {
  transition: all 0.3s ease;
  transform: scaleX(1.5);
  transform-origin: left;
  z-index: 10;
  position: relative;
}

.schedule-content {
  transform: none !important;
  display: block;
}
.schedule-box.expanding .schedule-content {
  transform: none !important;
  width: 100%;        /* שומר על הגודל המקורי */
}



.schedule-box {
  border-radius: 6px;
  padding: 10px 6px; /* יותר ריווח פנימי */
  margin: 4px 0;
  font-size: 13px; /* טקסט קריא יותר */
  cursor: pointer;
  color: white;
  font-weight: 500;
  text-align: center;
  box-shadow: 0 5px 2px rgba(0,0,0,0.15);
  border: 1px solid #fff;
  white-space: normal; /* מאפשר ירידת שורה */
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
  height: auto; /* שיבוץ ייגדל לגובה לפי תוכן */
  min-height: 70px; /* גובה מינימלי */
  transition: transform 0.3s ease, height 0.3s ease;
}


    /* MODALS */
    .modal-backdrop {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4); z-index:100;
      align-items:center; justify-content:center;
    }
    .modal {
      background:#fff; padding:20px; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      max-width:400px; width:90%;
      position:relative;
    }
    .modal h3 { margin-bottom:12px; color:#1E3A8A; }
    .modal label { display:block; margin:8px 0 4px; font-weight:500; }
    .modal input, .modal select {
      width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;
    }
    .modal button {
      margin-top:12px; padding:8px 12px; border:none; border-radius:4px;
      background:#2563EB; color:#fff; font-weight:600;
    }
    .modal button.cancel { background:#6B7280; }
    .modal ul { list-style:none; padding:0; max-height:200px; overflow-y:auto; }
    .modal ul li {
      padding:8px; border:1px solid #ddd; border-radius:4px; margin:6px 0;
      cursor:pointer; transition:background .2s;
    }
    .modal ul li:hover { background:#F3F4F6; }

    /* FOOTER */
    footer {
      background:#1E3A8A; color:#fff; text-align:center;
      padding:1rem; font-size:0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1><a href="/home" class="home-link">Classroom Scheduling System</a></h1>
  </header>

  <main>
    <h2 style="text-align:center">Weekly Visual Schedule</h2>
    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="previousDay()">&lt;</button>
        <span id="current-day-label">א'</span>
        <button onclick="nextDay()">&gt;</button>
    </div>
    <div style="text-align:center; margin-top: 10px; margin-bottom: 20px;">
  <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px;">
    <div style="display: flex; align-items: center; gap: 6px;">
      <div style="width: 20px; height: 20px; background-color: #2563EB; border-radius: 4px;"></div>
      <span>Computer Science</span>
    </div>
    <div style="display: flex; align-items: center; gap: 6px;">
      <div style="width: 20px; height: 20px; background-color: #10B981; border-radius: 4px;"></div>
      <span>Information Systems</span>
    </div>
    <div style="display: flex; align-items: center; gap: 6px;">
      <div style="width: 20px; height: 20px; background-color: #F59E0B; border-radius: 4px;"></div>
      <span>Other</span>
    </div>
  </div>
</div>


    <div style="overflow-x:auto">
        <div id="calendar-grid" class="calendar-grid"></div>
        <tbody id="schedule-body">
          
        </tbody>
      </table>
    </div>
  </main>

  <!-- Include existing edit modal -->
   <div id="editModalBackdrop" class="modal-backdrop" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <input type="hidden" id="modal-schedule-id" />
    <input type="hidden" id="modal-classroom" />

    <label>Course Name</label>
    <input type="text" id="modal-course-name" readonly />

    <label>Lecturer Name</label>
    <input type="text" id="modal-lecturer" readonly />

    <label>Weekday</label>
    <select id="modal-weekday">
  <option value="א'">א'</option>
  <option value="ב'">ב'</option>
  <option value="ג'">ג'</option>
  <option value="ד'">ד'</option>
  <option value="ה'">ה'</option>
  <option value="ו'">ו'</option>
   </select>


    <label>Start Time</label>
    <input type="time" id="modal-start" />

    <label>End Time</label>
    <input type="time" id="modal-end" />

    <label>Capacity</label>
    <input type="number" id="modal-capacity" />

    <label>Remote Learning</label>
    <select id="modal-remote">
  <option value="yes">Yes</option>
  <option value="no">No</option>
    </select>


    <label>Sheltered</label>
    <select id="modal-sheltered">
  <option value="yes">Yes</option>
  <option value="no">No</option>
    </select>


    <label>Number of Boards</label>
    <input type="number" id="modal-board-count" min="0" />

    <button onclick="submitEditModal()">Save</button>
    <button class="cancel" onclick="closeModal()">Cancel</button>
  </div>
</div>

 <!-- CLASSROOM SELECTION MODAL -->
  <div id="classroomModalBackdrop" class="modal-backdrop" onclick="closeClassroomModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Select New Classroom</h3>
      <ul id="classroom-options-list"></ul>
      <button class="cancel" onclick="closeClassroomModal()">Cancel</button>
    </div>
  </div>

  <script>
    let currentDayIndex = 0;
const weekdays = ["א'", "ב'", "ג'", "ד'", "ה'", "ו'"];

function updateDayLabel() {
  document.getElementById('current-day-label').textContent = weekdays[currentDayIndex];
}

function previousDay() {
  currentDayIndex = (currentDayIndex - 1 + weekdays.length) % weekdays.length;
  updateDayLabel();
  renderBuildingSchedule();
}

function nextDay() {
  currentDayIndex = (currentDayIndex + 1) % weekdays.length;
  updateDayLabel();
  renderBuildingSchedule();
}

    function closeModal() {
  document.getElementById('editModalBackdrop').style.display = 'none';
}

async function renderBuildingSchedule() {
  const res = await fetch('/api/schedules');
  const { schedules } = await res.json();
  const container = document.getElementById('calendar-grid');
  container.innerHTML = '';

  const selectedDay = weekdays[currentDayIndex];
  const filtered = schedules.filter(s => s.weekday === selectedDay);
  const buildings = [...new Set(filtered.map(s => s.building_name))].sort();
  const hours = Array.from({ length: 12 }, (_, i) => `${8 + i}:00`);

  function getFacultyColor(course_id) {
    const dept_code = course_id.split('.')[0];
    if (dept_code === '203') return '#2563EB'; // מדעי המחשב
    if (dept_code === '214') return '#10B981'; // מערכות מידע
    return '#F59E0B'; // שאר החוגים
  }

  const table = document.createElement('table');
  table.className = 'calendar-table';

  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.appendChild(document.createElement('th'));
  hours.forEach(hour => {
    const th = document.createElement('th');
    th.textContent = hour;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  buildings.forEach(building => {
    const row = document.createElement('tr');
    const nameCell = document.createElement('td');
    nameCell.textContent = building;
    row.appendChild(nameCell);

    hours.forEach(hour => {
      const cell = document.createElement('td');
      cell.style.position = 'relative';

      const matches = filtered.filter(s => {
        const startHour = parseInt(s.time_start.split(':')[0]);
        return s.building_name === building && startHour === parseInt(hour);
      });

      matches.forEach(s => {
        const start = s.time_start.split(':').map(Number);
        const end = s.time_end.split(':').map(Number);
        const startMin = start[0] * 60 + start[1];
        const endMin = end[0] * 60 + end[1];
        const durationMin = endMin - startMin;

        const block = document.createElement('div');
        block.className = 'schedule-box';
        block.style.backgroundColor = getFacultyColor(s.course_id);
        block.style.width = '100%';  // default
        block.style.position = 'relative';
        block.style.height = 'auto';
        block.style.transition = 'width 0.4s ease';

        block.innerHTML = `
        <div class="schedule-content">
              <strong>${s.course_name}</strong><br>
              ${s.classroom_num}<br>
              ${s.time_start} - ${s.time_end}<br>
              ${s.lecturer_name}
              </div>
              `;

        block.title = `Course: ${s.course_name}
Classroom: ${s.classroom_num}
Lecturer: ${s.lecturer_name}
${s.time_start} - ${s.time_end}`;

        // התרחבות רוחב מדויקת אחרי 2 שניות
        let expandTimeout;
        block.onmouseenter = () => {
          expandTimeout = setTimeout(() => {
            const scale = durationMin / 60;
            block.style.transformOrigin = 'left';
            block.style.transform = `scaleX(${scale})`;
            block.style.zIndex = '10';
          }, 2000);
        };
        block.onmouseleave = () => {
          clearTimeout(expandTimeout);
          block.style.transform = '';
          block.style.zIndex = '';
        };

        block.onclick = () => editRow(s.schedule_id);
        cell.appendChild(block);
      });

      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}


function formatTimeToInput(value) {
  if (!value || !value.includes(':')) return '';
  const [h, m] = value.split(':');
  return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
}


async function renderCalendarView() {
  const res = await fetch('/api/schedules');
  const { schedules } = await res.json();
  const container = document.getElementById('calendar-grid');
  container.innerHTML = '';

  const weekdays = ["א'", "ב'", "ג'", "ד'", "ה'", "ו'"];
  const hours = Array.from({ length: 12 }, (_, i) => `${8 + i}:00`);

  const table = document.createElement('table');
  table.classList.add('calendar-table');
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');

  headerRow.appendChild(document.createElement('th'));

  weekdays.forEach(day => {
    const th = document.createElement('th');
    th.textContent = day;
    headerRow.appendChild(th);
  });

  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  hours.forEach(hour => {
    const row = document.createElement('tr');
    const hourCell = document.createElement('td');
    hourCell.textContent = hour;
    row.appendChild(hourCell);

    weekdays.forEach(day => {
      const cell = document.createElement('td');
      cell.style.position = 'relative';

      schedules.forEach(s => {
        if (s.weekday === day && s.time_start.startsWith(hour)) {
          const box = document.createElement('div');
          box.className = 'schedule-box';
          box.innerHTML = `
            <strong>${s.course_name}</strong><br>
            ${s.lecturer_name}<br>
            ${s.classroom_num}<br>
            ${s.time_start} - ${s.time_end}
          `;
          box.onclick = () => editRow(s.schedule_id);
          cell.appendChild(box);
        }
      });

      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}

    async function loadVisualSchedule() {
      const res = await fetch('/api/schedules');
      const { schedules } = await res.json();
      const tbody = document.getElementById('schedule-body');
      tbody.innerHTML = '';

      const rooms = [...new Set(schedules.map(s => s.classroom_num))];
      const hours = [8,9,10,11,12,13,14,15,16,17,18,19];

      rooms.forEach(room => {
        const row = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = room;
        row.appendChild(td);

        hours.forEach(h => {
          const hourCell = document.createElement('td');

          const matches = schedules.filter(s => 
            s.classroom_num === room && parseInt(s.time_start.split(':')[0]) === h
          );

          matches.forEach(s => {
            const block = document.createElement('div');
            block.className = 'schedule-block';
            block.innerHTML = `
              ${s.course_name}<br>
              ${s.weekday} ${s.time_start} - ${s.time_end}<br>
              ${s.lecturer_name}
            `;
            block.onclick = () => editRow(s.schedule_id);
            hourCell.appendChild(block);
          });

          row.appendChild(hourCell);
        });

        tbody.appendChild(row);
      });
    }
async function submitEditModal() {
  const schedule_id = document.getElementById('modal-schedule-id').value;
  const weekday = document.getElementById('modal-weekday').value;
  const time_start = document.getElementById('modal-start').value;
  const time_end = document.getElementById('modal-end').value;
  const capacity = document.getElementById('modal-capacity').value;
  const is_remote_learning = document.getElementById('modal-remote').value;
  const is_sheltered = document.getElementById('modal-sheltered').value;
  const board_count = parseInt(document.getElementById('modal-board-count').value);

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    is_remote_learning,
    is_sheltered,
    board_count
  };

  const res = await fetch('/api/save_schedule_update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();

  if (result.success === false && result.message === "No available classroom matches the new constraints") {
    const classroomOptions = result.available_classrooms || [];
    if (classroomOptions.length > 0) {
      const modal = document.getElementById('classroomModalBackdrop');
      const list = document.getElementById('classroom-options-list');
      list.innerHTML = '';

      classroomOptions.forEach(c => {
        const li = document.createElement('li');

        li.innerHTML = `
          <div style="display:flex; gap:8px; justify-content:center; margin-bottom:8px;">
            <img src="/uploads/classroomimg1.png" alt="Classroom Image 1" style="width:48%; max-height:120px; object-fit:cover; border-radius:6px;" />
            <img src="/uploads/classroomimg2.png" alt="Classroom Image 2" style="width:48%; max-height:120px; object-fit:cover; border-radius:6px;" />
          </div>
          <strong>Classroom:</strong> ${c.classroom_num}<br>
          <strong>Capacity:</strong> ${c.capacity}<br>
          <strong>Building:</strong> ${c.building_name}<br>
          <strong>Remote Learning:</strong> ${c.is_remote_learning}<br>
          <strong>Sheltered:</strong> ${c.is_sheltered}<br>
          <strong>Boards:</strong> ${c.board_count}
        `;

        li.style.cursor = 'pointer';
        li.style.margin = '5px 0';
        li.style.padding = '5px';
        li.style.border = '1px solid #ccc';
        li.style.borderRadius = '5px';
        li.onmouseenter = () => li.style.backgroundColor = '#eee';
        li.onmouseleave = () => li.style.backgroundColor = 'white';

        li.onclick = async () => {
          if (!confirm(`Are you sure you want to switch to classroom ${c.classroom_num}?`)) return;

          data.selected_classroom_num = c.classroom_num;
          modal.style.display = 'none';

          const res2 = await fetch('/api/save_schedule_update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result2 = await res2.json();
          if (result2.success) {
            alert("Update successful");
            closeModal();
            renderBuildingSchedule();
          } else {
            alert("Update failed: " + result2.message);
          }
        };

        list.appendChild(li);
      });

      modal.style.display = 'flex';
      renderBuildingSchedule();
      return;
    }
  }

  if (result.success) {
    alert("Update successful");
    closeModal();
    renderBuildingSchedule();
  } else {
    alert("Update failed: " + result.message);
  }
}

async function editRow(schedule_id) {
  const res = await fetch(`/api/schedule_details/${schedule_id}`);
  const data = await res.json();

  document.getElementById('modal-schedule-id').value = schedule_id;
  document.getElementById('modal-classroom').value = data.classroom_num || '';  
  document.getElementById('modal-course-name').value = data.course_name || '';
  document.getElementById('modal-lecturer').value = data.lecturer_name || '';
  document.getElementById('modal-weekday').value = data.weekday || '';
  document.getElementById('modal-start').value = formatTimeToInput(data.time_start);
document.getElementById('modal-end').value = formatTimeToInput(data.time_end);

  document.getElementById('modal-capacity').value = data.capacity || '';
  document.getElementById('modal-remote').value = data.is_remote_learning || '';
  document.getElementById('modal-sheltered').value = data.is_sheltered || '';

  document.getElementById('modal-board-count').value = data.boards.length || 0;

  document.getElementById('editModalBackdrop').style.display = 'flex';

  window.originalSchedule = {
    weekday: data.weekday || '',
    time_start: data.time_start || '',
    time_end: data.time_end || '',
    capacity: data.capacity || '',
    is_remote_learning: data.is_remote_learning || '',
    is_sheltered: data.is_sheltered || '',
    board_count: data.boards.length || 0
  };
}

    function closeClassroomModal() {
      document.getElementById('classroomModalBackdrop').style.display = 'none';
    }
    window.onload = () => {
  updateDayLabel();
  renderBuildingSchedule();
  };


    async function loadSchedules() {
  const res = await fetch('/api/schedules');
  const json = await res.json();
  renderCalendarView(json.schedules || json);
}

  </script>

  <footer>
    <p>&copy; 2025 Classroom Scheduling System</p>
  </footer>
</body>
</html>
