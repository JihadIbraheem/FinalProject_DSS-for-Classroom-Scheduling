<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Schedule</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    let loaded = false;
    async function loadSchedules() {
      const res = await fetch('/api/schedules');
      const json = await res.json();
      const data = json.schedules || json;  // תמיכה בשתי אפשרויות
      const table = document.getElementById('schedule-table-body');
      table.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${row.classroom_num}</td>
        <td>${row.building_name}</td>
        <td>${row.course_id}</td>
        <td>${row.course_name}</td>
        <td>${row.lecturer_name}</td>
        <td>${row.weekday}</td>
        <td>${row.time_start}</td>
        <td>${row.time_end}</td>
        <td><button onclick="editRow(${row.schedule_id})">Edit</button></td>
        `;

        table.appendChild(tr);
      });
      loaded = true;
      filterSchedules();
    }

    function markEdited(input) {
      input.style.border = '2px solid orange';
    }

    async function saveRow(button, id) {
      const row = button.parentElement.parentElement;
      const inputs = row.querySelectorAll('input, select');
      const data = {
        schedule_id: id,
        classroom_id: inputs[0].value,
        course_id: inputs[1].value,
        schedule_datetime: inputs[2].value,
        time_start: inputs[3].value,
        time_end: inputs[4].value,
        status: inputs[5].value
      };

      const res = await fetch('/update_schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(data)
      });

      if (res.ok) {
        alert('Schedule updated successfully');
        loadSchedules();
      } else {
        alert('Error updating schedule');
      }
    }

async function editRow(schedule_id) {
  const res = await fetch(`/api/schedule_details/${schedule_id}`);
  const data = await res.json();

  document.getElementById('modal-schedule-id').value = schedule_id;
  document.getElementById('modal-classroom').value = data.classroom_num || '';  // ← שורה חדשה
  document.getElementById('modal-course-name').value = data.course_name || '';
  document.getElementById('modal-lecturer').value = data.lecturer_name || '';
  document.getElementById('modal-weekday').value = data.weekday || '';
  document.getElementById('modal-start').value = data.time_start || '';
  document.getElementById('modal-end').value = data.time_end || '';
  document.getElementById('modal-capacity').value = data.capacity || '';
  document.getElementById('modal-remote').value = data.is_remote_learning || '';
  document.getElementById('modal-sheltered').value = data.is_sheltered || '';

  document.getElementById('modal-board-count').value = data.boards.length || 0;

  document.getElementById('editModal').style.display = 'block';

  window.originalSchedule = {
    weekday: data.weekday || '',
    time_start: data.time_start || '',
    time_end: data.time_end || '',
    capacity: data.capacity || '',
    is_remote_learning: data.is_remote_learning || '',
    is_sheltered: data.is_sheltered || '',
    board_count: data.boards.length || 0
  };
}





function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

async function submitEditModal() {
  const schedule_id = document.getElementById('modal-schedule-id').value;
  const weekday = document.getElementById('modal-weekday').value;
  const time_start = document.getElementById('modal-start').value;
  const time_end = document.getElementById('modal-end').value;
  const capacity = document.getElementById('modal-capacity').value;
  const is_remote_learning = document.getElementById('modal-remote').value;
  const is_sheltered = document.getElementById('modal-sheltered').value;
  const board_count = parseInt(document.getElementById('modal-board-count').value);

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    is_remote_learning,
    is_sheltered,
    board_count
  };

    // Get original values for comparison
  const original = window.originalSchedule || {};

  // Check if any field changed
  const noChange =
    original.weekday === weekday &&
    original.time_start === time_start &&
    original.time_end === time_end &&
    String(original.capacity) === String(capacity) &&
    String(original.is_remote_learning) === String(is_remote_learning) &&
    String(original.is_sheltered) === String(is_sheltered) &&
    original.board_count === board_count;

  if (noChange) {
    alert("Please modify at least one constraint to check for available classrooms.");
    return;
  }

  const res = await fetch('/api/save_schedule_update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();

  // If no suitable classrooms found, show selection modal
  if (result.success === false && result.message === "No available classroom matches the new constraints") {
    const classroomOptions = result.available_classrooms || [];
    if (classroomOptions.length > 0) {
      const modal = document.getElementById('classroomSelectionModal');
      const list = document.getElementById('classroom-options-list');
      list.innerHTML = '';

      classroomOptions.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
        <strong>Classroom:</strong> ${c.classroom_num}<br>
        <strong>Capacity:</strong> ${c.capacity}<br>
        <strong>Building:</strong> ${c.building_name}<br>
        <strong>Remote Learning:</strong> ${c.is_remote_learning}<br>
        <strong>Sheltered:</strong> ${c.is_sheltered}<br>
        <strong>Boards:</strong> ${c.board_count}
        `;
        li.style.cursor = 'pointer';
        li.style.margin = '5px 0';
        li.style.padding = '5px';
        li.style.border = '1px solid #ccc';
        li.style.borderRadius = '5px';
        li.onmouseenter = () => li.style.backgroundColor = '#eee';
        li.onmouseleave = () => li.style.backgroundColor = 'white';

        li.onclick = async () => {
          const currentClassroomNum = document.getElementById('modal-classroom').value || 'Unknown';
          const confirmMsg = `Are you sure you want to switch from classroom ${currentClassroomNum} to ${c.classroom_num}?\n\n` +
                   `Current classroom: ${currentClassroomNum}\n` +
                   `New classroom: ${c.classroom_num} (${c.building_name})`;
          if (!confirm(confirmMsg)) return;

          data['selected_classroom_num'] = c.classroom_num;
          modal.style.display = 'none';

          const res2 = await fetch('/api/save_schedule_update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result2 = await res2.json();
          if (result2.success) {
            alert("Update successful");
            closeModal();
            loadSchedules();
          } else {
            alert("Update failed: " + result2.message);
          }
        };
        list.appendChild(li);
      });

      modal.style.display = 'block';
      return;
    }
  }

  // Normal update if no classroom selection was needed
  if (result.success) {
    alert("Update successful");
    closeModal();
    loadSchedules();
  } else {
    alert("Update failed: " + result.message);
  }
}



async function submitEdit(schedule_id) {
  const row = [...document.querySelectorAll('#schedule-table-body tr')].find(r => {
    return r.querySelector('button')?.outerHTML.includes(`submitEdit(${schedule_id})`);
  });

  const weekday = document.getElementById(`weekday-${schedule_id}`).value;
  const time_start = document.getElementById(`start-${schedule_id}`).value;
  const time_end = document.getElementById(`end-${schedule_id}`).value;
  const classroom = row.querySelectorAll('td')[0].textContent;
  const lecturer = row.querySelectorAll('td')[4].textContent;

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    classroom_num: classroom,
    lecturer_name: lecturer
  };

  const res = await fetch('/api/update_schedule_fields', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();

  if (result.success) {
    alert('Schedule updated successfully!');
    loadSchedules();
  } else {
    alert(`Update failed: ${result.message}`);
  }
}


   function filterSchedules() {
   const courseIdValue = document.getElementById('course-search').value.toLowerCase();
   const courseNameValue = document.getElementById('course-name-search')?.value.toLowerCase() || '';
   const lecturerValue = document.getElementById('lecturer-search')?.value.toLowerCase() || '';
  
   const weekdayFilter = document.getElementById('weekday-filter').value;
  
   const buildingsSelected = Array.from(document.getElementById('building-filter')?.selectedOptions || [])
    .map(opt => opt.value)
    .filter(val => val !== "");

   const table = document.getElementById('schedule-table-body');

   if (!loaded) {
    loadSchedules();
    return;
   }

   const rows = table.querySelectorAll('tr');
   rows.forEach(row => {
    const courseId = row.querySelectorAll('td')[2].textContent.toLowerCase();
    const courseName = row.querySelectorAll('td')[3].textContent.toLowerCase();
    const lecturer = row.querySelectorAll('td')[4].textContent.toLowerCase();
    const weekday = row.querySelectorAll('td')[5].textContent;
    const building = row.querySelectorAll('td')[1].textContent;

    const matchCourseId = courseId.includes(courseIdValue);
    const matchCourseName = courseNameValue.split(' ').some(word => courseName.includes(word));
    const matchLecturer = lecturerValue.split(' ').some(word => lecturer.includes(word));
    const matchWeekday = !weekdayFilter || weekday === weekdayFilter;
    const matchBuilding = buildingsSelected.length === 0 || buildingsSelected.includes(building);

    row.style.display = (matchCourseId && matchCourseName && matchLecturer && matchWeekday && matchBuilding) ? '' : 'none';
   });
   }


  
    window.onload = () => {
   document.getElementById('course-search').value = '';
   loadSchedules(); // טען את הטבלה בעת טעינת העמוד
   };

   function closeClassroomModal() {
  document.getElementById('classroomSelectionModal').style.display = 'none';
}


  </script>
</head>
<body>
  <header>
    <h1>
      <a href="/home" class="home-link">Classroom Scheduling System</a>
    </h1>
  </header>

  <main>
    <h2>Editable Schedule Table</h2>
    <label for="course-search">Search by Course ID:</label>
    <input type="text" id="course-search" placeholder="Enter course ID..." oninput="filterSchedules()" style="margin-bottom: 10px;">

    <label for="course-name-search">Course Name:</label>
    <input type="text" id="course-name-search" oninput="filterSchedules()">
    
    <label for="lecturer-search">Lecturer name:</label>
    <input type="text" id="lecturer-search" oninput="filterSchedules()">
    <br>
    
    <label for="weekday-filter">Filter by Weekday:</label>
    <select id="weekday-filter" onchange="filterSchedules()">
      <option value="">כל הימים</option>
      <option value="א'">א</option>
      <option value="ב'">ב</option>
      <option value="ג'">ג</option>
      <option value="ד'">ד</option>
      <option value="ה'">ה</option>
      <option value="ו'">ו</option>
     </select>

    
    <label for="building-filter">Filter by Building:</label>
    <select id="building-filter" onchange="filterSchedules()">
      <option value="">כל הבניינים</option>
      <option value="פורטאון">פורטאון</option>
      <option value="הכשרת היישוב">הכשרת היישוב</option>
      <option value="אולפן עציון">אולפן עציון</option>
      <option value="בניין דילן טאובר">בניין דילן טאובר</option>
      <option value="בניין עמיר">בניין עמיר</option>
    </select>


    <div class="scrollable-table">
      <table border="1" width="100%" style="border-collapse: collapse;">
        <thead>
          <tr>
            <th>Classroom</th>
            <th>Building</th>
            <th>Course ID</th>
            <th>Course Name</th>
            <th>Lecturer</th>
            <th>Weekday</th>
            <th>Start</th>
            <th>End</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="schedule-table-body"></tbody>
      </table>
    </div>
    
  </main>

  <!-- Modal popup for editing schedule -->
   <div id="editModal" class="modal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border:2px solid #ccc; border-radius:10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index:1000;width: 400px;">
    <h3>Update Schedule</h3>
    <form id="editForm">
       <label>Course Name:</label>
   <input type="text" id="modal-course-name" readonly><br><br>

   <label>Lecturer Name:</label>
   <input type="text" id="modal-lecturer" readonly><br><br>
      <label>Weekday:</label>
       <select id="modal-weekday">
        <option value="א'">א</option><option value="ב'">ב</option><option value="ג'">ג</option>
        <option value="ד'">ד</option><option value="ה'">ה</option><option value="ו'">ו</option>
       </select><br><br>
  
     <label>Start Time:</label>
     <input type="time" id="modal-start"><br><br>
     <label>End Time:</label>
     <input type="time" id="modal-end"><br><br>
     <input type="hidden" id="modal-schedule-id">
     <input type="hidden" id="modal-classroom">

   <label>Capacity:</label>
   <input type="number" id="modal-capacity"><br><br>

   <label>Remote Learning:</label>
   <select id="modal-remote">
  <option value="yes">Yes</option>
  <option value="no">No</option>
   </select><br><br>

   <label>Sheltered:</label>
   <select id="modal-sheltered">
    <option value="yes">Yes</option>
    <option value="no">No</option>
   </select><br><br>

   <label>Number of Boards:</label>
   <input type="number" id="modal-board-count" min="0"><br><br>


     <button type="button" onclick="submitEditModal()">Check available classrooms</button>
     <button type="button" onclick="closeModal()">Cancel</button>
   </form>
  </div>

  <div id="classroomSelectionModal" class="modal" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -30%); background:white; padding:20px; border:2px solid #ccc; border-radius:10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index:1001; width: 400px;">
  <h3>Select one of the available classrooms</h3>
  <ul id="classroom-options-list" style="list-style:none; padding:0;"></ul>
  <button onclick="closeClassroomModal()">Cancel</button>
</div>


  <footer>
    <p>&copy; 2025 Classroom Scheduling System</p>
  </footer>
</body>
</html>
