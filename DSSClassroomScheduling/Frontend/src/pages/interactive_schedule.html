<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Interactive Schedule</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    /* RESET & BASE */
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
    body { display:flex; flex-direction:column; min-height:100vh; background:#F3F4F6; color:#374151; }
    a { color:inherit; text-decoration:none; }
    button { cursor:pointer; }

    /* HEADER */
    header {
      background:#1E3A8A; color:#fff; padding:1rem 2rem;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .home-link { font-size:1.25rem; font-weight:600; }

    /* MAIN & FILTERS */
    main { flex:1; padding:2rem; }
    h2 { color:#1E3A8A; margin-bottom:1.5rem; text-align:center; }

    .filter-bar {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px;
    }
    .filter-bar input,
    .filter-bar select {
      padding:6px 10px; border-radius:4px; border:1px solid #ccc;
    }

    /* CARD GRID */
    .schedule-card-wrapper {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }
    .schedule-card {
      background:#fff; padding:16px; border-radius:8px;
      box-shadow:2px 2px 8px rgba(0,0,0,0.1);
      position:relative;
      display:flex; flex-direction:column;
    }
    .schedule-card h3 {
      margin-bottom:8px; font-size:1.1rem; color:#1E3A8A;
    }
    .schedule-card p { margin:4px 0; font-size:0.95rem; }
    .schedule-card button {
      margin-top:auto; padding:8px 12px; border:none;
      background:#2563EB; color:#fff; border-radius:4px;
      transition:background .2s;
    }
    .schedule-card button:hover { background:#1E40AF; }

    /* MODALS */
    .modal-backdrop {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4); z-index:100;
      align-items:center; justify-content:center;
    }
    .modal {
      background:#fff; padding:20px; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      max-width:400px; width:90%;
      position:relative;
    }
    .modal h3 { margin-bottom:12px; color:#1E3A8A; }
    .modal label { display:block; margin:8px 0 4px; font-weight:500; }
    .modal input, .modal select {
      width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;
    }
    .modal button {
      margin-top:12px; padding:8px 12px; border:none; border-radius:4px;
      background:#2563EB; color:#fff; font-weight:600;
    }
    .modal button.cancel { background:#6B7280; }
    .modal ul { list-style:none; padding:0; max-height:200px; overflow-y:auto; }
    .modal ul li {
      padding:8px; border:1px solid #ddd; border-radius:4px; margin:6px 0;
      cursor:pointer; transition:background .2s;
    }
    .modal ul li:hover { background:#F3F4F6; }

    /* FOOTER */
    footer {
      background:#1E3A8A; color:#fff; text-align:center;
      padding:1rem; font-size:0.9rem;
    }
  </style>
</head>
<body>

  <header>
    <a href="/home" class="home-link">Classroom Scheduling System</a>
    <a href="/logout" style="background:#fff;color:#1E3A8A;padding:6px 12px;border-radius:4px;">Log Out</a>
  </header>

  <main>
    <h2>Manage Schedules</h2>

    <!-- FILTER BAR -->
    <div class="filter-bar">
      <input type="text" id="filter-course-id" placeholder="Course ID" oninput="filterSchedules()">
      <input type="text" id="filter-course-name" placeholder="Course Name" oninput="filterSchedules()">
      <input type="text" id="filter-lecturer" placeholder="Lecturer" oninput="filterSchedules()">
      <select id="filter-weekday" onchange="filterSchedules()">
        <option value="">Any Day</option>
        <option>א'</option><option>ב'</option><option>ג'</option>
        <option>ד'</option><option>ה'</option><option>ו'</option>
      </select>
      <select id="filter-building" onchange="filterSchedules()">
        <option value="">Any Building</option>
        <option>פורטאון</option>
        <option>הכשרת היישוב</option>
        <option>אולפן עציון</option>
        <option>בניין דילן טאובר</option>
        <option>בניין עמיר</option>
      </select>
    </div>

    <!-- CARD CONTAINER -->
    <div id="schedule-cards-container" class="schedule-card-wrapper">
      <!-- cards injected here -->
    </div>
  </main>

<!-- EDIT MODAL -->
<div id="editModalBackdrop" class="modal-backdrop" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <input type="hidden" id="modal-schedule-id" />
    <input type="hidden" id="modal-classroom" />

    <label>Course Name</label>
    <input type="text" id="modal-course-name" readonly />

    <label>Lecturer Name</label>
    <input type="text" id="modal-lecturer" readonly />

    <label>Weekday</label>
    <select id="modal-weekday">
      <option value="א'">א'</option>
      <option value="ב'">ב'</option>
      <option value="ג'">ג'</option>
      <option value="ד'">ד'</option>
      <option value="ה'">ה'</option>
      <option value="ו'">ו'</option>
    </select>

    <label>Start Time</label>
    <input type="time" id="modal-start" />

    <label>End Time</label>
    <input type="time" id="modal-end" />

    <label>Capacity</label>
    <input type="number" id="modal-capacity" />

    <label>Remote Learning</label>
    <select id="modal-remote">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label>Sheltered</label>
    <select id="modal-sheltered">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label>Number of Boards</label>
    <input type="number" id="modal-board-count" min="0" />

    <button onclick="submitEditModal()">Save</button>
    <button class="cancel" onclick="closeModal()">Cancel</button>
  </div>
</div>


  <!-- CLASSROOM SELECTION MODAL -->
  <div id="classroomModalBackdrop" class="modal-backdrop" onclick="closeClassroomModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Select New Classroom</h3>
      <ul id="classroom-options-list"></ul>
      <button class="cancel" onclick="closeClassroomModal()">Cancel</button>
    </div>
  </div>

  <footer>&copy; 2025 Classroom Scheduling System</footer>

  <script>
    let schedules = [];

    async function loadSchedules() {
      const res = await fetch('/api/schedules');
      const json = await res.json();
      schedules = json.schedules || json;
      renderCards();
      filterSchedules();
    }

    function renderCards() {
      const container = document.getElementById('schedule-cards-container');
      container.innerHTML = '';
      schedules.forEach(r => {
        const card = document.createElement('div');
        card.className = 'schedule-card';
        card.dataset.course = (r.course_id + ' ' + r.course_name).toLowerCase();
        card.dataset.lecturer = r.lecturer_name.toLowerCase();
        card.dataset.weekday = r.weekday.toLowerCase();
        card.dataset.building = r.building_name.toLowerCase();
        card.innerHTML = `
          <h3>${r.course_id} - ${r.course_name}</h3>
          <p><strong>Classroom:</strong> ${r.classroom_num}</p>
          <p><strong>Building:</strong> ${r.building_name}</p>
          <p><strong>Lecturer:</strong> ${r.lecturer_name}</p>
          <p><strong>Day:</strong> ${r.weekday}</p>
          <p><strong>Time:</strong> ${r.time_start} - ${r.time_end}</p>
          <button onclick="editRow(${r.schedule_id})">Edit</button>
        `;
        container.appendChild(card);
      });
    }

    function filterSchedules() {
      const idFilter = document.getElementById('filter-course-id').value.toLowerCase();
      const nameFilter = document.getElementById('filter-course-name').value.toLowerCase();
      const lectFilter = document.getElementById('filter-lecturer').value.toLowerCase();
      const dayFilter = document.getElementById('filter-weekday').value.toLowerCase();
      const bldFilter = document.getElementById('filter-building').value.toLowerCase();

      document.querySelectorAll('.schedule-card').forEach(card => {
        const matchId = !idFilter || card.dataset.course.includes(idFilter);
        const matchName = !nameFilter || card.dataset.course.includes(nameFilter);
        const matchLect = !lectFilter || card.dataset.lecturer.includes(lectFilter);
        const matchDay = !dayFilter || card.dataset.weekday === dayFilter;
        const matchBld = !bldFilter || card.dataset.building === bldFilter;
        card.style.display = (matchId && matchName && matchLect && matchDay && matchBld) ? '' : 'none';
      });
    }

function editRow(schedule_id) {
  const schedule = schedules.find(s => s.schedule_id === schedule_id);
  if (!schedule) return;

  // הפנייה לעמוד עם פרמטרים: schedule_id ו-weekday
  const params = new URLSearchParams({
    schedule_id: schedule.schedule_id,
    weekday: schedule.weekday
  });

  window.location.href = `/second_schedule?${params.toString()}`;

}

   
    function closeModal() {
      document.getElementById('editModalBackdrop').style.display = 'none';
    }

async function submitEditModal() {
  const schedule_id = document.getElementById('modal-schedule-id').value;
  const weekday = document.getElementById('modal-weekday').value;
  const time_start = document.getElementById('modal-start').value;
  const time_end = document.getElementById('modal-end').value;
  const capacity = document.getElementById('modal-capacity').value;
  const is_remote_learning = document.getElementById('modal-remote').value;
  const is_sheltered = document.getElementById('modal-sheltered').value;
  const board_count = parseInt(document.getElementById('modal-board-count').value);

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    is_remote_learning,
    is_sheltered,
    board_count
  };

  const res = await fetch('/api/save_schedule_update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();

  if (result.success === false && result.message === "No available classroom matches the new constraints") {
    const classroomOptions = result.available_classrooms || [];
    if (classroomOptions.length > 0) {
      const modal = document.getElementById('classroomModalBackdrop');
      const list = document.getElementById('classroom-options-list');
      list.innerHTML = '';

      classroomOptions.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>Classroom:</strong> ${c.classroom_num}<br>
          <strong>Capacity:</strong> ${c.capacity}<br>
          <strong>Building:</strong> ${c.building_name}<br>
          <strong>Remote Learning:</strong> ${c.is_remote_learning}<br>
          <strong>Sheltered:</strong> ${c.is_sheltered}<br>
          <strong>Boards:</strong> ${c.board_count}
        `;
        li.style.cursor = 'pointer';
        li.onclick = async () => {
          if (!confirm(`Are you sure you want to switch to classroom ${c.classroom_num}?`)) return;

          data.selected_classroom_num = c.classroom_num;
          modal.style.display = 'none';

          const res2 = await fetch('/api/save_schedule_update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result2 = await res2.json();
          if (result2.success) {
            alert("Update successful");
            closeModal();
            loadSchedules();
          } else {
            alert("Update failed: " + result2.message);
          }
        };
        list.appendChild(li);
      });

      modal.style.display = 'flex';
      return;
    }
  }

  // אם לא הייתה בעיה או שבוצע עדכון תקין
  if (result.success) {
    alert("Update successful");
    closeModal();
    loadSchedules();
  } else {
    alert("Update failed: " + result.message);
  }
}

    // Classroom selection modal (if your flow still uses it)
    function closeClassroomModal() {
      document.getElementById('classroomModalBackdrop').style.display = 'none';
    }
    // ...populate and show #classroom-options-list as needed in your existing logic...

    // Initialize
    window.addEventListener('DOMContentLoaded', loadSchedules);
  </script>
</body>
</html>