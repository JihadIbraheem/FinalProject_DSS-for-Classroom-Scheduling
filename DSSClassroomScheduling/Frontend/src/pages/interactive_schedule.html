<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Schedule</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    let loaded = false;
    async function loadSchedules() {
      const res = await fetch('/api/schedules');
      const json = await res.json();
      const data = json.schedules || json;  // תמיכה בשתי אפשרויות
      const table = document.getElementById('schedule-table-body');
      table.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${row.classroom_num}</td>
        <td>${row.building_name}</td>
        <td>${row.course_id}</td>
        <td>${row.course_name}</td>
        <td>${row.lecturer_name}</td>
        <td>${row.weekday}</td>
        <td>${row.time_start}</td>
        <td>${row.time_end}</td>
        <td><button onclick="editRow(${row.schedule_id})">Edit</button></td>
        `;

        table.appendChild(tr);
      });
      loaded = true;
      filterSchedules();
    }

    function markEdited(input) {
      input.style.border = '2px solid orange';
    }

    async function saveRow(button, id) {
      const row = button.parentElement.parentElement;
      const inputs = row.querySelectorAll('input, select');
      const data = {
        schedule_id: id,
        classroom_id: inputs[0].value,
        course_id: inputs[1].value,
        schedule_datetime: inputs[2].value,
        time_start: inputs[3].value,
        time_end: inputs[4].value,
        status: inputs[5].value
      };

      const res = await fetch('/update_schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(data)
      });

      if (res.ok) {
        alert('Schedule updated successfully');
        loadSchedules();
      } else {
        alert('Error updating schedule');
      }
    }

function editRow(schedule_id) {
  const row = [...document.querySelectorAll('#schedule-table-body tr')].find(r =>
    r.querySelector('button')?.outerHTML.includes(`editRow(${schedule_id})`)
  );

  const cells = row.querySelectorAll('td');

  document.getElementById('modal-schedule-id').value = schedule_id;
  document.getElementById('modal-classroom').value = cells[0].textContent;
  document.getElementById('modal-lecturer').value = cells[4].textContent;
  document.getElementById('modal-weekday').value = cells[5].textContent;
  document.getElementById('modal-start').value = cells[6].textContent;
  document.getElementById('modal-end').value = cells[7].textContent;

  document.getElementById('editModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

async function submitEditModal() {
  const schedule_id = document.getElementById('modal-schedule-id').value;
  const weekday = document.getElementById('modal-weekday').value;
  const time_start = document.getElementById('modal-start').value;
  const time_end = document.getElementById('modal-end').value;
  const classroom = document.getElementById('modal-classroom').value;
  const lecturer = document.getElementById('modal-lecturer').value;

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    classroom_num: classroom,
    lecturer_name: lecturer
  };

  const res = await fetch('/api/update_schedule_fields', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if (result.success) {
    alert('Schedule updated successfully!');
    closeModal();
    loadSchedules();
  } else {
    alert('Update failed: ' + result.message);
  }
}

async function submitEdit(schedule_id) {
  const row = [...document.querySelectorAll('#schedule-table-body tr')].find(r => {
    return r.querySelector('button')?.outerHTML.includes(`submitEdit(${schedule_id})`);
  });

  const weekday = document.getElementById(`weekday-${schedule_id}`).value;
  const time_start = document.getElementById(`start-${schedule_id}`).value;
  const time_end = document.getElementById(`end-${schedule_id}`).value;
  const classroom = row.querySelectorAll('td')[0].textContent;
  const lecturer = row.querySelectorAll('td')[4].textContent;

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    classroom_num: classroom,
    lecturer_name: lecturer
  };

  const res = await fetch('/api/update_schedule_fields', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();

  if (result.success) {
    alert('Schedule updated successfully!');
    loadSchedules();
  } else {
    alert(`Update failed: ${result.message}`);
  }
}


   function filterSchedules() {
   const courseIdValue = document.getElementById('course-search').value.toLowerCase();
   const courseNameValue = document.getElementById('course-name-search')?.value.toLowerCase() || '';
   const lecturerValue = document.getElementById('lecturer-search')?.value.toLowerCase() || '';
  
   const weekdayFilter = document.getElementById('weekday-filter').value;
  
   const buildingsSelected = Array.from(document.getElementById('building-filter')?.selectedOptions || [])
    .map(opt => opt.value)
    .filter(val => val !== "");

   const table = document.getElementById('schedule-table-body');

   if (!loaded) {
    loadSchedules();
    return;
   }

   const rows = table.querySelectorAll('tr');
   rows.forEach(row => {
    const courseId = row.querySelectorAll('td')[2].textContent.toLowerCase();
    const courseName = row.querySelectorAll('td')[3].textContent.toLowerCase();
    const lecturer = row.querySelectorAll('td')[4].textContent.toLowerCase();
    const weekday = row.querySelectorAll('td')[5].textContent;
    const building = row.querySelectorAll('td')[1].textContent;

    const matchCourseId = courseId.includes(courseIdValue);
    const matchCourseName = courseNameValue.split(' ').some(word => courseName.includes(word));
    const matchLecturer = lecturerValue.split(' ').some(word => lecturer.includes(word));
    const matchWeekday = !weekdayFilter || weekday === weekdayFilter;
    const matchBuilding = buildingsSelected.length === 0 || buildingsSelected.includes(building);

    row.style.display = (matchCourseId && matchCourseName && matchLecturer && matchWeekday && matchBuilding) ? '' : 'none';
   });
   }


  
    window.onload = () => {
   document.getElementById('course-search').value = '';
   loadSchedules(); // טען את הטבלה בעת טעינת העמוד
   };


  </script>
</head>
<body>
  <header>
    <h1>
      <a href="/home" class="home-link">Classroom Scheduling System</a>
    </h1>
  </header>

  <main>
    <h2>Editable Schedule Table</h2>
    <label for="course-search">Search by Course ID:</label>
    <input type="text" id="course-search" placeholder="Enter course ID..." oninput="filterSchedules()" style="margin-bottom: 10px;">

    <label for="course-name-search">Course Name:</label>
    <input type="text" id="course-name-search" oninput="filterSchedules()">
    
    <label for="lecturer-search">Lecturer name:</label>
    <input type="text" id="lecturer-search" oninput="filterSchedules()">
    <br>
    
    <label for="weekday-filter">Filter by Weekday:</label>
    <select id="weekday-filter" onchange="filterSchedules()">
      <option value="">כל הימים</option>
      <option value="א'">א</option>
      <option value="ב'">ב</option>
      <option value="ג'">ג</option>
      <option value="ד'">ד</option>
      <option value="ה'">ה</option>
      <option value="ו'">ו</option>
     </select>

    
    <label for="building-filter">Filter by Building:</label>
    <select id="building-filter" onchange="filterSchedules()">
      <option value="">כל הבניינים</option>
      <option value="פורטאון">פורטאון</option>
      <option value="הכשרת היישוב">הכשרת היישוב</option>
      <option value="אולפן עציון">אולפן עציון</option>
      <option value="בניין דילן טאובר">בניין דילן טאובר</option>
      <option value="בניין עמיר">בניין עמיר</option>
    </select>


    <div class="scrollable-table">
      <table border="1" width="100%" style="border-collapse: collapse;">
        <thead>
          <tr>
            <th>Classroom</th>
            <th>Building</th>
            <th>Course ID</th>
            <th>Course Name</th>
            <th>Lecturer</th>
            <th>Weekday</th>
            <th>Start</th>
            <th>End</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="schedule-table-body"></tbody>
      </table>
    </div>
    
  </main>

  <!-- Modal popup for editing schedule -->
   <div id="editModal" class="modal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border:2px solid #ccc; border-radius:10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index:1000;width: 320px;">
    <h3>Update Schedule</h3>
    <form id="editForm">
      <label>Weekday:</label>
       <select id="modal-weekday">
        <option value="א'">א</option><option value="ב'">ב</option><option value="ג'">ג</option>
        <option value="ד'">ד</option><option value="ה'">ה</option><option value="ו'">ו</option>
       </select><br><br>
     <label>Start Time:</label>
     <input type="time" id="modal-start"><br><br>
     <label>End Time:</label>
     <input type="time" id="modal-end"><br><br>
     <input type="hidden" id="modal-schedule-id">
     <input type="hidden" id="modal-classroom">
     <input type="hidden" id="modal-lecturer">
     <button type="button" onclick="submitEditModal()">Save</button>
     <button type="button" onclick="closeModal()">Cancel</button>
   </form>
  </div>


  <footer>
    <p>&copy; 2025 Classroom Scheduling System</p>
  </footer>
</body>
</html>
