
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Interactive Schedule</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    /* RESET & BASE */
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
    body { display:flex; flex-direction:column; min-height:100vh; background:#bfd2f8; color:#374151; }
    a { color:inherit; text-decoration:none; }
    button { cursor:pointer; }

    /* HEADER */
    header {
      background:#1E3A8A; color:#fff; padding:1rem 2rem;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .home-link { font-size:1.25rem; font-weight:600; }
    
    /* MAIN & FILTERS */
    main { flex:1; padding:2rem; }
    h2 {  color: #1E3A8A;
  margin-bottom: 1.5rem;
  text-align: center;
  font-size: 2rem; 
  font-weight: 600; 
  text-transform: uppercase;
letter-spacing: 1px;

}

.history-card {
  background: #ffffffee;
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  border-left: 6px solid #3B82F6;
  transition: transform 0.3s ease;
}

.history-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.history-header {
  font-size: 1.2rem;
  font-weight: bold;
  color: #1E3A8A;
  margin-bottom: 10px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.history-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 12px;
}

.history-content {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.history-before, .history-after {
  flex: 1;
  border-radius: 10px;
  padding: 12px;
  background: #f1f5f9;
}

.history-before {
  background: #fee2e2;
}

.history-after {
  background: #dcfce7;
}

.history-before h4,
.history-after h4 {
  margin-bottom: 8px;
  color: #1E3A8A;
  font-size: 1rem;
}

    .button-glass {
  padding: 10px 16px;
  border: none;
  border-radius: 12px;
  font-weight: bold;
  font-size: 0.95rem;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
  color: white;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.button-glass:hover {
  transform: scale(1.05);
}

.button-green {
  background: linear-gradient(135deg, #16A34A, #087d5c);
}

.button-red {
  background: linear-gradient(135deg, #DC2626, #aa2929);
}
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 20px;
}

.filter-bar input,
.filter-bar select {
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  background: #ffffff;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.06);
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

.filter-bar input:focus,
.filter-bar select:focus {
  border-color: #3B82F6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  outline: none;
}


    /* CARD GRID */
    .schedule-card-wrapper {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }
.schedule-card {
    background: rgba(255, 255, 255, 0.927);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.3);
  
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  position: relative;
  display: flex;
  flex-direction: column;
  transition: transform 0.3s, box-shadow 0.3s;
  border-left: 6px solid #2347a9;
  animation: fadeIn 0.4s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.schedule-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}


    .schedule-card h3 {
        margin-bottom: 10px;
  font-size: 1.2rem;
  color: #1a42af;
  font-weight: 600;
    }
    .schedule-card p {
        padding: 4px 0;
  border-bottom: 1px solid #eee;
  margin: 6px 0;
  font-size: 0.96rem;
  color: #374151;
  line-height: 1.4;
    }
    .schedule-card button {
      margin-top:auto; padding:8px 12px; border:none;
      background:#2563EB; color:#fff; border-radius:4px;
      transition:background .2s;
    }
    .schedule-card button:hover { background:#1E40AF; }

    /* MODALS */
    .modal-backdrop {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4); z-index:100;
      align-items:center; justify-content:center;
    }
    .modal {
     background: #fff;
     padding: 20px;
     border-radius: 8px;
     box-shadow: 0 4px 12px rgba(0,0,0,0.2);
     max-width: 500px;
     width: 95%;
     max-height: 90vh;
     overflow-y: auto;
     position: relative;
    }

    .modal h3 { margin-bottom:12px; color:#1E3A8A; }
    .modal label { display:block; margin:8px 0 4px; font-weight:500; }
    .modal input, .modal select {
      width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;
    }
    .modal button {
      margin-top:12px; padding:8px 12px; border:none; border-radius:4px;
      background:#2563EB; color:#fff; font-weight:600;
    }
    .modal button.cancel { background:#6B7280; }
    .modal ul { list-style:none; padding:0; max-height:200px; overflow-y:auto; }
    .modal ul li {
      padding:8px; border:1px solid #ddd; border-radius:4px; margin:6px 0;
      cursor:pointer; transition:background .2s;
    }
    .modal ul li:hover { background:#F3F4F6; }
    .history-wrapper {
  background: #f8fafc;
  border: 2px solid #cbd5e1;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  max-height: 350px;
  overflow-y: auto;
}

    #history-cards::-webkit-scrollbar {
  width: 8px;
}
#history-cards::-webkit-scrollbar-thumb {
  background-color: #ccc;
  border-radius: 6px;
}
#history-cards::-webkit-scrollbar-track {
  background-color: transparent;
}


    .logout-button {
  background: #ffffff;
  color: #1E3A8A;
  padding: 6px 12px;
  border-radius: 4px;
  font-weight: bold;
  transition: all 0.3s ease;
  }

.logout-button:hover {
  background-color: #e5e7eb; /* ◊ê◊§◊ï◊® ◊ë◊î◊ô◊® */
  color: #111827; /* ◊õ◊î◊î ◊ô◊ï◊™◊® */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.history-wrapper-beautiful {
  background: linear-gradient(to bottom right, #f0f4ff, #e0f2fe);
  padding: 30px;
  border-radius: 18px;
  border: 1px solid #cbd5e1;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  max-height: 450px;
  overflow-y: auto;
  position: relative;
}

/* ◊°◊®◊í◊ú ◊í◊ú◊ô◊ú◊î */
.history-wrapper-beautiful::-webkit-scrollbar {
  width: 10px;
}
.history-wrapper-beautiful::-webkit-scrollbar-thumb {
  background-color: #93c5fd;
  border-radius: 8px;
}
.history-wrapper-beautiful::-webkit-scrollbar-track {
  background: #e2e8f0;
}


    /* FOOTER */
    footer {
      background:#1E3A8A; color:#fff; text-align:center;
      padding:1rem; font-size:0.9rem;
    }
  </style>
</head>
<body>

  <header>
    <a href="/home" class="home-link">Classroom Scheduling System</a>
    <a href="/logout" class="logout-button">Log Out</a>
  </header>

  <main>
    <h2>Manage Schedules</h2>


    <!-- FILTER BAR -->
    <div class="filter-bar">
      <input type="text" id="filter-course-id" placeholder="Course ID" oninput="filterSchedules()">
      <input type="text" id="filter-course-name" placeholder="Course Name" oninput="filterSchedules()">
      <input type="text" id="filter-lecturer" placeholder="Lecturer" oninput="filterSchedules()">
      <select id="filter-weekday" onchange="filterSchedules()">
        <option value="">Any Day</option>
        <option>◊ê'</option><option>◊ë'</option><option>◊í'</option>
        <option>◊ì'</option><option>◊î'</option><option>◊ï'</option>
      </select>
      <select id="filter-building" onchange="filterSchedules()">
         <option value="">Any Building</option>
        </select>
      <select id="filter-classroom" onchange="filterSchedules()">
        <option value="">Any Classroom</option>
      </select>

    </div>

<div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
<button onclick="openAddScheduleModal()" class="button-glass button-green">
  Add New Schedule
</button>

<button onclick="toggleHistory()" id="history-toggle" class="button-glass button-green">
  Show Schedule History
</button>

<button onclick="toggleShowOnlyIssues()" id="issues-toggle" class="button-glass button-red">
  ‚ö†Ô∏è Show Capacity Issues
</button>


</div>

<!-- SCHEDULE HISTORY SECTION -->
<div id="schedule-history" style="max-width: 1000px; margin: 40px auto; display: none;">
  <div class="history-wrapper-beautiful">
    <h2 style="text-align: center; margin-bottom: 1rem; color: #1E3A8A;">Schedule Change History</h2>
    <div style="text-align: center; margin-bottom: 1rem;">
      <input type="text" id="history-search-input" placeholder="üîç Search Course Name..." 
         style="padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; width: 300px;
         box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-size: 1rem; transition: 0.3s;" 
         oninput="filterHistoryCards()" />
      </div>

    <div id="history-cards" style="display: flex; flex-direction: column; gap: 20px;">
      <!-- Cards will be loaded here -->
    </div>
  </div>
</div>



    <!-- CARD CONTAINER -->
    <div id="schedule-cards-container" class="schedule-card-wrapper">
      <!-- cards injected here -->
    </div>
  </main>

<!-- EDIT MODAL -->
<div id="editModalBackdrop" class="modal-backdrop" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <input type="hidden" id="modal-schedule-id" />
    <input type="hidden" id="modal-classroom" />

    <label>Course Name</label>
    <input type="text" id="modal-course-name" readonly />

    <label>Lecturer Name</label>
    <input type="text" id="modal-lecturer" readonly />

    <label>Weekday</label>
    <select id="modal-weekday">
      <option value="◊ê'">◊ê'</option>
      <option value="◊ë'">◊ë'</option>
      <option value="◊í'">◊í'</option>
      <option value="◊ì'">◊ì'</option>
      <option value="◊î'">◊î'</option>
      <option value="◊ï'">◊ï'</option>
    </select>

    <label>Start Time</label>
    <input type="time" id="modal-start" />

    <label>End Time</label>
    <input type="time" id="modal-end" />

    <label>Capacity</label>
    <input type="number" id="modal-capacity" />

    <label>Remote Learning</label>
    <select id="modal-remote">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label>Sheltered</label>
    <select id="modal-sheltered">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label>Number of Boards</label>
    <input type="number" id="modal-board-count" min="0" />

    <button onclick="submitEditModal()">Save</button>
    <button class="cancel" onclick="closeModal()">Cancel</button>
  </div>
</div>

<div id="editCourseModalBackdrop" class="modal-backdrop" onclick="closeCourseModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Edit Course Information</h3>
    <input type="hidden" id="edit-course-id" />

    <label>Course Name</label>
    <input type="text" id="edit-course-name" />

    <label>Lecturer Name</label>
    <input type="text" id="edit-lecturer-name" />

    <label>Number of Students</label>
    <input type="number" id="edit-students-num" min="0" />

    <button onclick="submitCourseEdit()">Save</button>
    <button onclick="closeCourseModal()" style="position: absolute; top: 0px; right: 0px; background: none; border: none; font-size: 33px; color: #d32b2b;">&times;</button>
  </div>
</div>

<!-- ADD SCHEDULE MODAL -->
<div id="addScheduleModalBackdrop" class="modal-backdrop" onclick="closeAddScheduleModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Add New Schedule</h3>

    <label>Is this a one-time schedule?</label>
    <select id="is-onetime">
      <option value="no">Recurring</option>
      <option value="yes">One-Time</option>
    </select>

    <label>Course ID</label>
    <input type="text" id="new-course-id" />

    <label>Course Name</label>
    <input type="text" id="new-course-name" />

    <label>Lecturer</label>
    <input type="text" id="new-lecturer" />

    <label>Number of Students</label>
    <input type="number" id="new-capacity" />

    <label>Duration (hours)</label>
    <input type="number" id="new-duration" />

    <label>Weekday</label>
    <select id="new-weekday">
      <option value="">No Preference</option>
      <option value="◊ê'">◊ê'</option>
      <option value="◊ë'">◊ë'</option>
      <option value="◊í'">◊í'</option>
      <option value="◊ì'">◊ì'</option>
      <option value="◊î'">◊î'</option>
      <option value="◊ï'">◊ï'</option>
    </select>


    <label>Remote Learning</label>
    <select id="new-remote">
      <option value="">Doesn't matter</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label>Sheltered Room</label>
    <select id="new-sheltered">
      <option value="">Doesn't matter</option>
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>

    <div id="end-date-group" style="display:none;">
      <label>End Date (if one-time)</label>
      <input type="date" id="new-end-date" />
    </div>


    <button onclick="submitNewSchedule()">Submit</button>
    <button onclick="closeAddScheduleModal()" style="position: absolute; top: 0px; right: 0px; background: none; border: none; font-size: 33px; color: #d32b2b;">&times;</button>
  </div>
</div>


  <!-- CLASSROOM SELECTION MODAL -->
  <div id="classroomModalBackdrop" class="modal-backdrop" onclick="closeClassroomModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Select New Classroom</h3>
      <ul id="classroom-options-list"></ul>
      <button class="cancel" onclick="closeClassroomModal()">Cancel</button>
    </div>
  </div>



  <footer>&copy; 2025 Classroom Scheduling System</footer>

  <script>
    let schedules = [];
    let showOnlyIssues = false;


window.addEventListener('DOMContentLoaded', async () => {
  const res = await fetch('/api/schedules');
  schedules = await res.json();
  renderCards();

  // ‚úÖ ◊°◊ô◊†◊ï◊ü ◊ú◊§◊ô ◊õ◊ô◊™◊î ◊©◊¢◊ï◊ì◊õ◊†◊î
  const filterClassroomId = sessionStorage.getItem('filterClassroomId');
  if (filterClassroomId) {
    const classroomFilter = document.getElementById('filter-classroom');

    // ◊û◊ï◊°◊ô◊£ ◊ê◊™ ◊î◊õ◊ô◊™◊î ◊ú◊®◊©◊ô◊û◊™ ◊î◊°◊ô◊†◊ï◊ü ◊ê◊ù ◊î◊ô◊ê ◊ú◊ê ◊ß◊ô◊ô◊û◊™
    let alreadyExists = false;
    for (let option of classroomFilter.options) {
      if (option.value === filterClassroomId) {
        alreadyExists = true;
        break;
      }
    }
    if (!alreadyExists) {
      const newOption = document.createElement('option');
      newOption.value = filterClassroomId;
      newOption.textContent = filterClassroomId.padStart(3, '0');
      classroomFilter.appendChild(newOption);
    }

    classroomFilter.value = filterClassroomId;
    filterSchedules();  // ◊ß◊®◊ô◊ê◊î ◊ú◊°◊ô◊†◊ï◊ü ◊ë◊§◊ï◊¢◊ú
  }
});


async function loadSchedules() {
  const res = await fetch('/api/schedules');
  const json = await res.json();
  schedules = json.schedules || json;
  renderCards();
  filterSchedules();

  // ‚úÖ ◊°◊ô◊†◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊ê◊ù ◊ô◊© classroomId ◊û◊î◊ß◊ô◊ë◊ï◊ú◊™ ◊©◊©◊ï◊†◊™◊î
  const problematicClassroom = sessionStorage.getItem('problematicClassroomId');
  if (problematicClassroom) {
    const classroomFilter = document.getElementById('filter-classroom');
    if (classroomFilter) {
      classroomFilter.value = problematicClassroom.padStart(3, '0');
      filterSchedules();
    }
  }
}
async function loadScheduleHistory() {
  const res = await fetch('/api/schedule_history');
  const data = await res.json();
  const historyList = data.history || [];
  const container = document.getElementById('history-cards');
  container.innerHTML = '';

  historyList.forEach(h => {
    const card = document.createElement('div');
    card.className = 'history-card';
    card.innerHTML = `
      <div class="history-header">${h.course_name}</div>
      <div class="history-meta">
        <span><strong>Updated by:</strong> ${h.username}</span>
        <span><strong>On:</strong> ${new Date(h.update_timestamp).toLocaleString()}</span>
      </div>
      <div class="history-content">
        <div class="history-before">
          <h4>Before</h4>
          <p><strong>Day:</strong> ${h.old_weekday}</p>
          <p><strong>Time:</strong> ${h.old_time_start} - ${h.old_time_end}</p>
          <p><strong>Room:</strong> ${h.old_classroom_num} (${h.old_building})</p>
        </div>
        <div class="history-after">
          <h4>After</h4>
          <p><strong>Day:</strong> ${h.new_weekday}</p>
          <p><strong>Time:</strong> ${h.new_time_start} - ${h.new_time_end}</p>
          <p><strong>Room:</strong> ${h.new_classroom_num} (${h.new_building})</p>
        </div>
      </div>
    `;
    container.appendChild(card);
  });

}

document.getElementById('filter-building').addEventListener('change', async function () {
  const buildingName = this.value;

  const classroomSelect = document.getElementById('filter-classroom');
  classroomSelect.innerHTML = `<option value="">Any Classroom</option>`;

  if (!buildingName) {
    filterSchedules();
    return;
  }

  try {
    const res = await fetch(`/api/classrooms_by_building?building_name=${encodeURIComponent(buildingName)}`);
    const classrooms = await res.json();

    classrooms.forEach(c => {
      const option = document.createElement('option');
      option.value = c.classroom_num;
      option.textContent = c.classroom_num.split('-').pop();  // ◊®◊ß 3 ◊°◊§◊®◊ï◊™ ◊ê◊ó◊®◊ï◊†◊ï◊™
      classroomSelect.appendChild(option);
    });
  } catch (err) {
    console.error("Error loading classrooms:", err);
  }

  filterSchedules();
});

function filterHistoryCards() {
  const searchValue = document.getElementById('history-search-input').value.toLowerCase();
  const cards = document.querySelectorAll('#history-cards .history-card');

  cards.forEach(card => {
    const courseName = card.querySelector('.history-header')?.textContent.toLowerCase() || '';
    card.style.display = courseName.includes(searchValue) ? '' : 'none';
  });
}

function renderCards() {
  const container = document.getElementById('schedule-cards-container');
  container.innerHTML = '';

  const problematic = JSON.parse(sessionStorage.getItem('problematicSchedules') || "[]");
  const problematicIds = problematic.map(s => s.schedule_id);
  const problematicClassroom = sessionStorage.getItem('problematicClassroomId');
  const classroomToFilterRaw = sessionStorage.getItem('filterClassroomId');
  const classroomToFilter = classroomToFilterRaw ? parseInt(classroomToFilterRaw) : null;

  let anyRendered = false;

  schedules.forEach(r => {
    if (classroomToFilter) {
      const classroomShort = (r.classroom_num || '').split('-').pop();
      if (parseInt(classroomShort) !== classroomToFilter) {
        return;
      }
    }

    const hasLecturerIssue = !r.lecturer_name || r.lecturer_name.trim() === '';
    const hasStudentsIssue = !r.students_num || r.students_num < 1;
    const hasIssue = hasLecturerIssue || hasStudentsIssue;
    const isOneTime = !!r.schedule_end_date;

    let issueTooltip = '';
    if (hasLecturerIssue && hasStudentsIssue) {
      issueTooltip = "Missing lecturer name and number of students is missing or less than 0";
    } else if (hasLecturerIssue) {
      issueTooltip = "Missing lecturer name";
    } else if (hasStudentsIssue) {
      issueTooltip = "Number of students is missing or less than 0";
    }

    const classroomShort = r.classroom_num?.split('-').pop();

    const card = document.createElement('div');
    card.className = 'schedule-card';
    card.dataset.course = (r.course_id + ' ' + r.course_name).toLowerCase();
    card.dataset.lecturer = (r.lecturer_name || '').toLowerCase();
    card.dataset.weekday = r.weekday.toLowerCase();
    card.dataset.building = r.building_name.toLowerCase();
    card.dataset.classroom = classroomShort;
    card.dataset.issue = hasIssue ? 'yes' : 'no';
    card.dataset.scheduleid = r.schedule_id;
    card.dataset.classroomid = r.classroom_id;

    let warningMessage = '';
    const isProblematic = (
      parseInt(r.classroom_id) === parseInt(problematicClassroom) &&
      problematicIds.includes(r.schedule_id)
    );

    if (isProblematic || r.exceeds_capacity) {
      card.style.border = "2px solid #DC2626";
      card.style.background = "linear-gradient(to bottom, #fee2e2, #fff)";
      card.style.boxShadow = "0 0 8px rgba(220, 38, 38, 0.3)";
      card.style.position = "relative";

      warningMessage += `
        <div style="
          background-color: #DC2626;
          color: white;
          padding: 6px 10px;
          border-radius: 6px;
          font-weight: bold;
          font-size: 0.9rem;
          margin-top: 12px;
          box-shadow: 0 0 4px rgba(0,0,0,0.1);
          display: flex;
          align-items: center;
          gap: 8px;">
          ‚ö†Ô∏è Students exceed classroom capacity!
        </div>`;
    }

    if (isOneTime) {
      warningMessage += `
        <div style="
          background: linear-gradient(to right, #FDE68A, #FBBF24);
          color: #92400E;
          padding: 6px 12px;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.9rem;
          margin-top: 8px;
          box-shadow: 0 0 4px rgba(251, 191, 36, 0.4);
          display: inline-block;">
          üìÖ One-Time Schedule: ${new Date(r.schedule_end_date).toLocaleDateString()}
        </div>`;
    }

    card.innerHTML = `
      <div class="card-header" style="
        background: linear-gradient(to right, #3B82F6, #2347a9);
        color: white;
        padding: 8px 12px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
        font-size: 1.05rem;">
        ${r.course_name}
        ${hasIssue ? `<span title="${issueTooltip}" style="color: #DC2626; cursor: help;">üîß</span>` : ''}
      </div>
      <p style="font-weight: bold; color: #1e3a8a; font-size: 0.95rem;">
        <strong>Course ID:</strong> 
        <span dir="ltr" style="display: inline-block;">
          ${r.course_id.replace(/(\\d)([◊ê-◊™])/, '$1 $2')}
        </span>
      </p>
      <p><strong>Classroom:</strong> ${classroomShort} <span style="color: #6b7280; font-size: 0.85rem;">(Capacity: ${r.classroom_capacity || '‚Äî'})</span></p>
      <p><strong>Building:</strong> ${r.building_name}</p>
      <p><strong>Lecturer:</strong> ${r.lecturer_name || '‚Äî'}</p>
      <p><strong>Students:</strong> ${r.students_num || '‚Äî'}</p>
      <p><strong>Day:</strong> ${r.weekday}</p>
      <p><strong>Time:</strong> ${r.time_start} - ${r.time_end}</p>
      ${warningMessage}
      <div class="actions" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
        <button onclick="editRow(${r.schedule_id})" style="
          background-color: #3B82F6;
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          transition: 0.3s;">Edit Schedule</button>

        <button onclick='editCourse(
          ${JSON.stringify(r.course_id || "")}, 
          ${JSON.stringify(r.course_name || "")}, 
          ${JSON.stringify(r.lecturer_name || "")}, 
          ${Number.isInteger(r.students_num) ? r.students_num : 0}
        )' style="
          background-color: #10B981;
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          transition: 0.3s;">Fix Course Info</button>

        <button onclick="confirmDelete('${r.schedule_id}', '${r.course_id}')" style="
          background-color: #DC2626;
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          transition: 0.3s;">üóëÔ∏è Delete</button>
      </div>
    `;

    container.appendChild(card);
    anyRendered = true;
  });

  if (!anyRendered) {
    container.innerHTML = `<div style="text-align:center; margin-top:2rem; font-weight:bold; color:#b91c1c;">
      ‚ö†Ô∏è No schedules found for the updated classroom.
    </div>`;
  }

  sessionStorage.removeItem('filterClassroomId');
  sessionStorage.removeItem('problematicSchedules');
  sessionStorage.removeItem('problematicClassroomId');
}

function toggleHistory() {
  const historySection = document.getElementById('schedule-history');
  const toggleBtn = document.getElementById('history-toggle');

  if (historySection.style.display === 'none') {
    historySection.style.display = 'block';
    toggleBtn.textContent = '‚ùå Hide Schedule History';
    loadScheduleHistory();  
  } else {
    historySection.style.display = 'none';
    toggleBtn.textContent = 'Show Schedule History';
  }
}


function editCourse(course_id, name, lecturer, students) {
  document.getElementById('edit-course-id').value = course_id;
  document.getElementById('edit-course-name').value = name;
  document.getElementById('edit-lecturer-name').value = lecturer;
  document.getElementById('edit-students-num').value = students;
  document.getElementById('editCourseModalBackdrop').style.display = 'flex';
}

function closeCourseModal() {
  document.getElementById('editCourseModalBackdrop').style.display = 'none';
}

async function submitCourseEdit() {
  const courseId = document.getElementById('edit-course-id').value;
  const courseName = document.getElementById('edit-course-name').value;
  const lecturerName = document.getElementById('edit-lecturer-name').value;
  const studentsInput = document.getElementById('edit-students-num').value.trim();

  const data = {
    course_id: courseId,
    course_name: courseName,
    lecturer_name: lecturerName,
    students_num: studentsInput === '' ? null : parseInt(studentsInput)
  };

  const res = await fetch('/api/update_course_info', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if (result.success) {
    alert("Course info updated");
    closeCourseModal();
    loadSchedules();
  } else {
    alert("Update failed: " + result.message);
  }
}


  document.getElementById('is-onetime').addEventListener('change', function () {
    const selected = this.value;
    const endDateGroup = document.getElementById('end-date-group');
    if (selected === 'yes') {
      endDateGroup.style.display = 'block';
    } else {
      endDateGroup.style.display = 'none';
      document.getElementById('new-end-date').value = '';
    }
  });

function openAddScheduleModal() {
  if (schedules.length === 0) {
    alert("Cannot add schedule: No existing data found in the system.");
    return;
  }
  document.getElementById('addScheduleModalBackdrop').style.display = 'flex';
}


function closeAddScheduleModal() {
  document.getElementById('addScheduleModalBackdrop').style.display = 'none';
}

function confirmDelete(scheduleId, courseId) {
    if (confirm("Are you sure you want to delete this schedule?")) {
        fetch('/delete_schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ schedule_id: scheduleId, course_id: courseId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Schedule deleted successfully!");
                location.reload();
            } else {
                alert("Error deleting schedule: " + data.message);
            }
        });
    }
}

document.addEventListener("DOMContentLoaded", () => {
  const problematic = JSON.parse(sessionStorage.getItem('problematicSchedules') || "[]");
  const problematicIds = problematic.map(s => s.schedule_id);
  const problematicClassroom = sessionStorage.getItem('problematicClassroomId');

  // ◊ê◊ù ◊ô◊© ◊ë◊¢◊ô◊ï◊™ ‚Äì ◊™◊°◊û◊ü ◊®◊ß ◊ê◊ï◊™◊ü ◊ï◊™◊°◊™◊ô◊® ◊ê◊™ ◊î◊©◊ê◊®
  if (problematic.length > 0 && problematicClassroom) {
    document.querySelectorAll('.schedule-card').forEach(card => {
      const isProblematic = (
        card.dataset.classroomid === problematicClassroom &&
        problematicIds.includes(parseInt(card.dataset.scheduleid))
      );

      if (isProblematic) {
        card.style.border = "3px solid #DC2626";
        card.style.backgroundColor = "#fef2f2";
        card.style.display = ''; // ◊î◊¶◊í
      } else {
        card.style.display = 'none'; // ◊î◊°◊™◊®
      }
    });
  }

  // ◊†◊ß◊î ◊ê◊™ SessionStorage ◊ê◊ó◊®◊ô ◊ò◊¢◊ô◊†◊î
  sessionStorage.removeItem('problematicSchedules');
  sessionStorage.removeItem('problematicClassroomId');
});


async function submitNewSchedule() {
  const duration = parseFloat(document.getElementById('new-duration').value);
  const studentsNum = parseInt(document.getElementById('new-capacity').value);
  const endDate = document.getElementById('new-end-date').value;
  const isOneTime = document.getElementById('is-onetime').value === 'yes';

  // ◊ë◊ì◊ô◊ß◊î: ◊û◊©◊ö ◊ñ◊û◊ü ◊ó◊ô◊ô◊ë ◊ú◊î◊ô◊ï◊™ ◊ë◊ô◊ü 0 ◊ú÷æ8
  if (duration > 8 || duration < 0) {
    alert("Duration must be between 0 and 8.");
    return;
  }

  // ◊ë◊ì◊ô◊ß◊î: ◊™◊ê◊®◊ô◊ö ◊°◊ô◊ï◊ù ◊ó◊ô◊ô◊ë ◊ú◊î◊ô◊ï◊™ ◊¢◊™◊ô◊ì◊ô ◊ê◊ù ◊û◊ì◊ï◊ë◊® ◊ë◊©◊ô◊ë◊ï◊• ◊ó◊ì÷æ◊§◊¢◊û◊ô
  if (isOneTime && endDate) {
    const today = new Date();
    const inputDate = new Date(endDate);
    today.setHours(0, 0, 0, 0);
    inputDate.setHours(0, 0, 0, 0);
    if (inputDate <= today) {
      alert("End date must be in the future.");
      return;
    }
  }

  // ◊ë◊ì◊ô◊ß◊î: ◊û◊°◊§◊® ◊î◊°◊ò◊ï◊ì◊†◊ò◊ô◊ù ◊ú◊ê ◊ô◊õ◊ï◊ú ◊ú◊ó◊®◊ï◊í ◊û◊î◊ß◊ô◊ë◊ï◊ú◊™ ◊î◊û◊ß◊°◊ô◊û◊ú◊ô◊™
  const capacityResponse = await fetch('/api/get_max_capacity');
  const { max_capacity } = await capacityResponse.json();
  if (studentsNum > max_capacity || studentsNum < 0) {
    alert(`Number of students cannot exceed the maximum classroom capacity (${max_capacity}).`);
    return;
  }

  // ◊ß◊®◊ô◊ê◊î ◊ú◊¢◊®◊õ◊ô◊ù ◊û◊î◊©◊ì◊ï◊™
  const weekday = document.getElementById('new-weekday').value;
  const remoteLearning = document.getElementById('new-remote').value;
  const shelteredRoom = document.getElementById('new-sheltered').value;

  // ◊î◊õ◊†◊î ◊ú◊†◊™◊ï◊†◊ô◊ù ◊ú◊©◊ô◊í◊ï◊® ◊ú◊©◊®◊™
  const data = {
    course_id: document.getElementById('new-course-id').value,
    course_name: document.getElementById('new-course-name').value,
    lecturer_name: document.getElementById('new-lecturer').value,
    students_num: studentsNum,
    duration: duration,
    weekday: weekday !== "" ? weekday : null,
    is_remote_learning: remoteLearning !== "" ? remoteLearning : null,
    is_sheltered: shelteredRoom !== "" ? shelteredRoom : null,
    is_onetime: isOneTime ? 'yes' : 'no',
    schedule_end_date: endDate || null
  };

  // ◊©◊ú◊ô◊ó◊™ ◊î◊†◊™◊ï◊†◊ô◊ù
  const res = await fetch('/api/add_schedule_from_ui', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if (result.success) {
    alert("Schedule added successfully!");
    closeAddScheduleModal();
    loadSchedules();
  } else {
    alert("Error: " + result.message);
  }
}


document.addEventListener("DOMContentLoaded", function () {
  fetch('/api/buildings')
    .then(response => response.json())
    .then(buildings => {
      const select = document.getElementById('filter-building');
      if (!select) return;

      buildings.forEach(building => {
        const option = document.createElement('option');
        option.value = building.building_name;
        option.textContent = building.building_name;
        select.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error fetching buildings:', error);
    });
});


function filterSchedules() {
  const courseId = document.getElementById('filter-course-id').value.toLowerCase();
  const courseName = document.getElementById('filter-course-name').value.toLowerCase();
  const lecturer = document.getElementById('filter-lecturer').value.toLowerCase();
  const weekday = document.getElementById('filter-weekday').value.toLowerCase();
  const building = document.getElementById('filter-building').value.toLowerCase();
  const classroom = document.getElementById('filter-classroom').value;

  const cards = document.querySelectorAll('.schedule-card');

  cards.forEach(card => {
    const matchesCourse = card.dataset.course.includes(courseId) && card.dataset.course.includes(courseName);
    const matchesLecturer = card.dataset.lecturer.includes(lecturer);
    const matchesDay = weekday === '' || card.dataset.weekday === weekday;
    const matchesBuilding = building === '' || card.dataset.building === building;

    const classroomShort = card.dataset.classroom;
    const matchesClassroom = classroom === '' || classroom.endsWith(classroomShort);  // ◊©◊ô◊û◊ï◊© ◊ë-endsWith

    const hasCapacityIssue = card.innerHTML.includes("‚ö†Ô∏è Students exceed classroom capacity!");

    const matchesFilters = matchesCourse && matchesLecturer && matchesDay && matchesBuilding && matchesClassroom;
    const shouldShow = matchesFilters && (!showOnlyIssues || hasCapacityIssue);

    card.style.display = shouldShow ? '' : 'none';
  });
}


let showingOnlyIssues = false;

function toggleShowOnlyIssues() {
  showingOnlyIssues = !showingOnlyIssues;
  const toggleBtn = document.getElementById('issues-toggle');
  toggleBtn.textContent = showingOnlyIssues ? 'Show All' : '‚ö†Ô∏è Show Capacity Issues';

  document.querySelectorAll('.schedule-card').forEach(card => {
    if (showingOnlyIssues && card.dataset.issue !== 'yes') {
      card.style.display = 'none';
    } else {
      card.style.display = '';
    }
  });
}

function editRow(schedule_id) {
  const schedule = schedules.find(s => s.schedule_id === schedule_id);
  if (!schedule) return;

  // ◊î◊§◊†◊ô◊ô◊î ◊ú◊¢◊û◊ï◊ì ◊¢◊ù ◊§◊®◊û◊ò◊®◊ô◊ù: schedule_id ◊ï-weekday
  const params = new URLSearchParams({
    schedule_id: schedule.schedule_id,
    weekday: schedule.weekday
  });

  window.location.href = `/second_schedule?${params.toString()}`;

}

   
    function closeModal() {
      document.getElementById('editModalBackdrop').style.display = 'none';
    }

async function submitEditModal() {
  const schedule_id = document.getElementById('modal-schedule-id').value;
  const weekday = document.getElementById('modal-weekday').value;
  const time_start = document.getElementById('modal-start').value;
  const time_end = document.getElementById('modal-end').value;
  const capacity = document.getElementById('modal-capacity').value;
  const is_remote_learning = document.getElementById('modal-remote').value;
  const is_sheltered = document.getElementById('modal-sheltered').value;
  const board_count = parseInt(document.getElementById('modal-board-count').value);

  const data = {
    schedule_id,
    weekday,
    time_start,
    time_end,
    capacity,
    is_remote_learning,
    is_sheltered,
    board_count
  };

  const res = await fetch('/api/save_schedule_update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  const result = await res.json();

  if (result.success === false && result.message === "No available classroom matches the new constraints") {
    const classroomOptions = result.available_classrooms || [];
    if (classroomOptions.length > 0) {
      const modal = document.getElementById('classroomModalBackdrop');
      const list = document.getElementById('classroom-options-list');
      list.innerHTML = '';

      classroomOptions.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>Classroom:</strong> ${c.classroom_num}<br>
          <strong>Capacity:</strong> ${c.capacity}<br>
          <strong>Building:</strong> ${c.building_name}<br>
          <strong>Remote Learning:</strong> ${c.is_remote_learning}<br>
          <strong>Sheltered:</strong> ${c.is_sheltered}<br>
          <strong>Boards:</strong> ${c.board_count}
        `;
        li.style.cursor = 'pointer';
        li.onclick = async () => {
          if (!confirm(`Are you sure you want to switch to classroom ${c.classroom_num}?`)) return;

          data.selected_classroom_num = c.classroom_num;
          modal.style.display = 'none';

          const res2 = await fetch('/api/save_schedule_update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result2 = await res2.json();
          if (result2.success) {
            alert("Update successful");
            closeModal();
            loadSchedules();
          } else {
            alert("Update failed: " + result2.message);
          }
        };
        list.appendChild(li);
      });

      modal.style.display = 'flex';
      return;
    }
  }

  // ◊ê◊ù ◊ú◊ê ◊î◊ô◊ô◊™◊î ◊ë◊¢◊ô◊î ◊ê◊ï ◊©◊ë◊ï◊¶◊¢ ◊¢◊ì◊õ◊ï◊ü ◊™◊ß◊ô◊ü
  if (result.success) {
    alert("Update successful");
    closeModal();
    loadSchedules();
  } else {
    alert("Update failed: " + result.message);
  }
}

async function loadBuildings() {
  const res = await fetch('/api/buildings');
  const data = await res.json();
  if (data.buildings) {
    const select = document.getElementById('filter-building');
    data.buildings.forEach(building => {
      const opt = document.createElement('option');
      opt.value = building.building_name;
      opt.textContent = building.building_name;
      select.appendChild(opt);
    });
  }
}

function toggleShowOnlyIssues() {
  showOnlyIssues = !showOnlyIssues;
  document.getElementById('issues-toggle').textContent = showOnlyIssues ? 'Show All' : '‚ö†Ô∏è Show Capacity Issues';
  filterSchedules();
}


    function closeClassroomModal() {
      document.getElementById('classroomModalBackdrop').style.display = 'none';
    }

    // Initialize
window.addEventListener('DOMContentLoaded', () => {
  loadSchedules();
  loadBuildings();
});

  </script>
</body>
</html>